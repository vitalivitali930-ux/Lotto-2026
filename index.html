<!DOCTYPE html>
<html lang="ru" translate="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VCHF Durak Triple Crown | The Bulb</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Вишневый бархат: Свет только в центре, края во тьме */
            --cherry-velvet-dark: radial-gradient(circle at center 30%, #800020 0%, #3a000a 60%, #000 100%);
            /* Тусклое, ламповое золото */
            --gold-dim: #cc9900; 
            --gold-bright: #d4af37;
            --white: #ffffff;
            --card-shadow: 0 10px 30px rgba(0,0,0,0.8);
        }
        
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        
        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            background: var(--cherry-velvet-dark); 
            font-family: 'Orbitron', sans-serif; 
            overflow: hidden; color: white;
            position: relative;
        }
        
        /* Эффект тусклой лампочки над центром стола */
        body::after {
            content: '';
            position: fixed;
            top: 30%; left: 50%;
            transform: translate(-50%, -50%);
            width: 80vh; height: 80vh;
            background: radial-gradient(circle, rgba(204, 153, 0, 0.1) 0%, transparent 60%);
            pointer-events: none;
            z-index: 10;
        }

        /* Меню выбора режима */
        #mode-selector {
            position: fixed; inset: 0; 
            background: rgba(0,0,0,0.95); 
            z-index: 1000;
            display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 20px;
            backdrop-filter: blur(10px);
        }

        .btn-mode {
            width: 280px; padding: 20px; 
            border: 2px solid var(--gold-dim); background: none;
            color: var(--gold-dim); font-family: 'Orbitron'; font-weight: 900; cursor: pointer; border-radius: 15px; 
            transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        .btn-mode:hover { 
            background: var(--gold-dim); color: black; 
            box-shadow: 0 0 30px rgba(204, 153, 0, 0.3); 
            transform: scale(1.05);
        }

        /* Игровой интерфейс */
        #table { 
            position: relative; width: 100%; height: 100vh; 
            display: flex; flex-direction: column; justify-content: space-between; align-items: center; 
            padding: env(safe-area-inset-top) 10px env(safe-area-inset-bottom) 10px; 
        }
        
        .hand { display: flex; justify-content: center; width: 100%; height: 130px; transition: 0.5s; position: relative; z-index: 20; }
        #enemy-hand { transform: translateY(-10px) rotate(180deg); } /* Оппонент в тени сверху */
        #player-hand { transform: translateY(10px); } /* Ты в свете лампы снизу */
        
        #play-zone { 
            flex-grow: 1; width: 100%; max-width: 500px; 
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; 
            align-content: center; justify-items: center; 
            position: relative; z-index: 15;
        }
        
        /* КАРТА под лампой */
        .card {
            width: 75px; height: 110px; background: #fff; border-radius: 8px; border: 1.5px solid var(--gold-dim);
            position: relative; cursor: pointer; color: #000; display: flex; flex-direction: column; justify-content: space-between; padding: 5px;
            box-shadow: var(--card-shadow);
            transition: all 0.3s ease;
        }
        
        /* Рубашка с логотипом GLOBAL LOTTO TOOL */
        .card.back { background: #fff url('1771489965074(1).png') no-repeat center; background-size: 85%; }
        
        .card.in-hand:hover {
            transform: translateY(-20px) scale(1.1);
            box-shadow: 0 15px 40px rgba(0,0,0,0.9), 0 0 10px rgba(212, 175, 55, 0.2);
            z-index: 30;
        }

        .card .val { align-self: center; font-size: 22px; font-weight: 900; }
        .red { color: #d00; }

        /* Эффект Перевода */
        .transfer-anim { animation: transferFlow 0.6s ease-in-out; }
        @keyframes transferFlow { 0% { opacity: 1; } 50% { transform: translateY(-150px); opacity: 0; } 100% { opacity: 1; } }

        /* UI */
        .ui-panel { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); display: flex; flex-direction: column; gap: 15px; z-index: 50; }
        .btn-vchf { 
            background: rgba(0,0,0,0.8); border: 1.5px solid var(--gold-dim); color: var(--gold-dim); 
            padding: 12px; border-radius: 8px; font-family: 'Orbitron'; font-weight: 700; font-size: 10px; 
            box-shadow: 0 5px 15px #000;
            cursor: pointer;
            text-transform: uppercase;
        }
        
        #status { position: absolute; top: env(safe-area-inset-top); font-size: 11px; color: var(--gold-dim); text-transform: uppercase; letter-spacing: 3px; }
    </style>
</head>
<body>

<div id="mode-selector">
    <img src="1771489965074(1).png" alt="Logo" style="width: 70px; margin-bottom: 20px;">
    <h2 style="color:var(--gold-dim); margin-top:0;">CHOOSE ENGINE</h2>
    <button class="btn-mode" onclick="startGame('normal')">Классический</button>
    <button class="btn-mode" onclick="startGame('throw')">Подкидной</button>
    <button class="btn-mode" onclick="startGame('transfer')">Переводной</button>
</div>

<div id="table" style="display:none">
    <div id="status">INITIALIZING...</div>
    <div id="enemy-hand" class="hand"></div>
    <div id="play-zone"></div>
    <div class="ui-panel">
        <button id="action-btn" class="btn-vchf" onclick="mainAction()">В ОЖИДАНИИ</button>
        <button class="btn-vchf" style="border-color:#555; color:#777" onclick="location.reload()">MENU</button>
    </div>
    <div id="player-hand" class="hand"></div>
</div>

<script>
    /** МАНИФЕСТ МОНОЛИТА: 3-in-1 DURAK ENGINE v1.5 "UNDER THE BULB" **/
    const tg = window.Telegram.WebApp;
    const suits = ['♠', '♣', '♥', '♦'], values = ['6','7','8','9','10','J','Q','K','A'];
    const power = {'6':6,'7':7,'8':8,'9':9,'10':10,'J':11,'Q':12,'K':13,'A':14};
    
    let deck=[], pHand=[], eHand=[], table=[], trump=null, mode='', isPAttack=true;

    function startGame(m) {
        mode = m;
        document.getElementById('mode-selector').style.display = 'none';
        document.getElementById('table').style.display = 'flex';
        init();
    }

    function init() {
        deck = [];
        suits.forEach(s => values.forEach(v => deck.push({s, v, red: (s==='♥'||s==='♦')})));
        for(let i=deck.length-1; i>0; i--){ const j=Math.floor(Math.random()*(i+1)); [deck[i], deck[j]]=[deck[j], deck[i]]; }
        trump = deck[0];
        draw();
        render();
        updateStatus(isPAttack ? "Твой ход" : "Враг ходит");
    }

    function draw() {
        while(pHand.length<6 && deck.length > 0) pHand.push(deck.pop());
        while(eHand.length<6 && deck.length > 0) eHand.push(deck.pop());
    }

    function render() {
        const ph = document.getElementById('player-hand'); ph.innerHTML = '';
        pHand.sort((a,b)=>power[a.v]-power[b.v]).forEach((c,i) => {
            const el = createUI(c);
            el.onclick = () => play(i);
            ph.appendChild(el);
        });

        const eh = document.getElementById('enemy-hand'); eh.innerHTML = '';
        eHand.forEach(() => eh.appendChild(createUI(null, true)));

        const pz = document.getElementById('play-zone'); pz.innerHTML = '';
        table.forEach(pair => {
            const d = document.createElement('div'); d.style.position='relative';
            d.appendChild(createUI(pair.at));
            if(pair.df) {
                const df = createUI(pair.df); df.style.position='absolute'; df.style.top='20px'; df.style.left='15px'; df.style.zIndex='10';
                d.appendChild(df);
            }
            pz.appendChild(d);
        });
        updateBtn();
    }

    function createUI(c, hidden=false) {
        const d = document.createElement('div');
        d.className = 'card' + (hidden ? ' back' : ' in-hand');
        if(!hidden) {
            const r = c.red ? 'red' : '';
            d.innerHTML = `<div style="font-size:12px; font-weight:900" class="${r}">${c.s}</div><div class="val ${r}">${c.v}</div><div style="align-self:flex-end; font-size:12px; font-weight:900" class="${r}">${c.s}</div>`;
            if(c.s === trump.s) d.style.borderColor = 'var(--gold-bright)';
        }
        return d;
    }

    function play(idx) {
        const c = pHand[idx];
        if(isPAttack) {
            // ЛОГИКА АТАКИ (Классика + Подкидной)
            if(table.length > 0 && mode !== 'normal') {
                const vals = table.flatMap(p => [p.at.v, p.df?.v]).filter(Boolean);
                if(!vals.includes(c.v)) return;
            } else if (table.length > 0 && mode === 'normal') return;
            
            table.push({at: c, df: null});
            pHand.splice(idx,1);
            setTimeout(enemyReact, 600);
        } else {
            // ЛОГИКА ЗАЩИТЫ + ПЕРЕВОД
            const canTransfer = mode === 'transfer' && table.every(p => !p.df) && table.length > 0 && c.v === table[0].at.v;
            
            if(canTransfer) {
                table.push({at: c, df: null});
                pHand.splice(idx,1);
                isPAttack = true; // Перевели ход!
                updateStatus("ПЕРЕВОД!");
                document.getElementById('play-zone').classList.add('transfer-anim');
                setTimeout(() => document.getElementById('play-zone').classList.remove('transfer-anim'), 600);
                setTimeout(enemyReact, 800);
            } else {
                const target = table.find(p => !p.df);
                if(target && beat(c, target.at)) {
                    target.df = c; pHand.splice(idx,1);
                    setTimeout(enemyReact, 600);
                }
            }
        }
        render();
    }

    function beat(c1, c2) {
        if(c1.s === c2.s) return power[c1.v] > power[c2.v];
        return c1.s === trump.s;
    }

    function enemyReact() {
        if(isPAttack) {
            const pair = table.find(p => !p.df);
            if(!pair) return;
            const idx = eHand.findIndex(c => beat(c, pair.at));
            if(idx !== -1) { pair.df = eHand.splice(idx,1)[0]; }
            else { updateStatus("Враг берет"); enemyTake(); }
        } else {
            // Враг атакует
            if(table.length === 0) { table.push({at: eHand.pop(), df: null}); }
            else if(mode !== 'normal') {
                const vals = table.flatMap(p => [p.at.v, p.df?.v]).filter(Boolean);
                const idx = eHand.findIndex(c => vals.includes(c.v));
                if(idx !== -1 && table.length < 6) table.push({at: eHand.splice(idx,1)[0], df: null});
                else { updateStatus("Враг: БИТО"); }
            }
        }
        render();
    }

    function enemyTake() {
        eHand.push(...table.flatMap(p => [p.at, p.df]).filter(Boolean));
        table = []; draw(); isPAttack = true; updateStatus("Твой ход"); render();
    }

    function mainAction() {
        if(isPAttack) {
            table=[]; draw(); isPAttack=false; updateStatus("Враг ходит"); setTimeout(enemyReact, 600);
        } else {
            const needsTake = table.some(p => !p.df);
            if(needsTake) { pHand.push(...table.flatMap(p => [p.at, p.df]).filter(Boolean)); table=[]; draw(); isPAttack=false; setTimeout(enemyReact, 600); }
            else { table=[]; draw(); isPAttack=true; updateStatus("Твой ход"); }
        }
        render();
    }

    function updateBtn() {
        const b = document.getElementById('action-btn');
        if(isPAttack) { b.innerText = table.length > 0 ? "БИТО" : "ХОДИ"; }
        else { b.innerText = table.some(p => !p.df) ? "ВЗЯТЬ" : "БИТО"; }
    }

    function updateStatus(s) { 
        document.getElementById('status').innerText = s; 
        tg.HapticFeedback.notificationOccurred(s === 'ПЕРЕВОД!' ? 'success' : 'light'); 
    }
</script>
</body>
</html>
