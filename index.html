<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lotto Bi-Turbo Ultimate 2026</title>
    <style>
        :root {
            --vchf-glow: 0 0 15px #00ff00;
            --chaos-red: #ff0033;
            --bg-deep: #0a0a0a;
            --card-gold: #ffd700;
        }

        body, html {
            margin: 0; padding: 0;
            background: var(--bg-deep);
            color: #fff;
            font-family: 'Orbitron', sans-serif;
            overflow: hidden;
            height: 100vh;
        }

        #ritual-canvas {
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: -1;
            background: radial-gradient(circle, #1a1a1a 0%, #000 100%);
        }

        /* МАГИСТРАЛЬ ИГРОВОГО ПОЛЯ */
        .game-container {
            display: flex; flex-direction: column;
            justify-content: space-between;
            height: 100vh; padding: 20px;
            box-sizing: border-box;
        }

        /* ВЕЕР ИИ (ТУМАН ВОЙНЫ) */
        .enemy-zone {
            display: flex; justify-content: center;
            height: 150px; perspective: 1000px;
        }
        .enemy-card-shadow {
            width: 80px; height: 120px;
            background: linear-gradient(135deg, #111, #222);
            border: 2px solid #333;
            border-radius: 8px;
            margin: -20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            transition: all 0.5s ease;
        }

        /* ПОЛЕ БОЯ (ЛИМИТ 12 КАРТ) */
        .battle-ground {
            flex-grow: 1;
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            grid-gap: 15px;
            align-items: center; justify-items: center;
            padding: 40px;
            border: 1px solid rgba(0, 255, 0, 0.1);
            border-radius: 20px;
            position: relative;
        }

        /* КАРТА */
        .card {
            width: 100px; height: 150px;
            background: #fff; border-radius: 10px;
            color: #000; position: relative;
            cursor: pointer; transition: transform 0.3s, box-shadow 0.3s;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            font-weight: bold; font-size: 20px;
            user-select: none;
        }
        .card:hover { transform: translateY(-10px) scale(1.05); box-shadow: var(--vchf-glow); }
        .card.trump { border: 3px solid var(--card-gold); box-shadow: 0 0 10px var(--card-gold); }
        .card.mirror { border: 3px dashed var(--chaos-red); animation: pulse 1s infinite; }

        /* ИНТЕРФЕЙС УПРАВЛЕНИЯ */
        .ui-layer {
            display: flex; justify-content: center; gap: 20px; padding: 20px;
        }
        .vchf-btn {
            padding: 15px 40px; font-size: 18px;
            background: transparent; color: #00ff00;
            border: 2px solid #00ff00; border-radius: 30px;
            cursor: pointer; transition: 0.3s;
            text-transform: uppercase; letter-spacing: 2px;
        }
        .vchf-btn:hover { background: #00ff00; color: #000; box-shadow: var(--vchf-glow); }
        .vchf-btn:disabled { opacity: 0.3; cursor: not-allowed; }

        /* ТАЙМЕР И КОЗЫРЬ */
        .status-panel {
            position: absolute; right: 20px; top: 50%; transform: translateY(-50%);
            display: flex; flex-direction: column; align-items: center; gap: 10px;
        }
        #vchf-line {
            width: 5px; height: 200px; background: #333; position: relative;
        }
        #vchf-progress {
            width: 100%; height: 100%; background: #00ff00; transition: height 0.1s linear;
        }
        #current-trump {
            width: 60px; height: 90px; border: 2px solid var(--card-gold);
            border-radius: 5px; display: flex; justify-content: center;
            align-items: center; font-size: 24px; background: rgba(255,215,0,0.1);
        }

        @keyframes pulse {
            0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <canvas id="ritual-canvas"></canvas>
    <div class="game-container">
        <div class="enemy-zone" id="enemy-hand-visual">
            </div>

        <div class="battle-ground" id="battle-table">
            </div>

        <div class="enemy-zone" id="player-hand-visual" style="margin-top: 20px;">
            </div>

        <div class="ui-layer">
            <button id="btn-take" class="vchf-btn" onclick="handleTake()">ВЗЯТЬ</button>
            <button id="btn-bito" class="vchf-btn" onclick="handleBito()" disabled>БИТО</button>
        </div>
    </div>

    <div class="status-panel">
        <div id="current-trump">?</div>
        <div id="vchf-line"><div id="vchf-progress"></div></div>
        <div style="font-size: 10px;">ENGINE VCHF</div>
    </div>

    <script>
        // КОНСТАНТЫ МОНОЛИТА
        const SUITS = ['♠', '♣', '♥', '♦'];
        const RANKS = ['6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];
        const RANK_VALUES = { '6':6, '7':7, '8':8, '9':9, '10':10, 'J':11, 'Q':12, 'K':13, 'A':14 };

        let vchf_state = {
            deck: [],
            pHand: [],
            eHand: [],
            table: [], // {card, type: 'attack'|'defend', slot: 0-5}
            trump: null,
            oldTrump: null,
            isMirrorRound: false,
            turn: 'player', // 'player' | 'enemy'
            timer: 30,
            active: false,
            phase: 'idle', // 'attack', 'defend', 'take_window'
            takeTimer: null
        };
        // --- WINDOW 2: ЛОГИКА КОЛОДЫ И ВИЗУАЛИЗАЦИЯ ---

        // Создание колоды 36 сфер
        function initDeck() {
            vchf_state.deck = [];
            SUITS.forEach(suit => {
                RANKS.forEach(rank => {
                    vchf_state.deck.push({
                        suit: suit,
                        rank: rank,
                        val: RANK_VALUES[rank],
                        id: Math.random().toString(36).substr(2, 9)
                    });
                });
            });
            shuffle(vchf_state.deck);
        }

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        // Раздача Монолита (18 карт каждому - Без колоды в остатке)
        function dealCards() {
            vchf_state.pHand = vchf_state.deck.splice(0, 18);
            vchf_state.eHand = vchf_state.deck.splice(0, 18);
            
            // Установка стартового козыря
            vchf_state.trump = SUITS[Math.floor(Math.random() * SUITS.length)];
            updateTrumpUI();
            renderHands();
        }

        function updateTrumpUI() {
            const el = document.getElementById('current-trump');
            el.innerText = vchf_state.trump;
            el.style.color = (vchf_state.trump === '♥' || vchf_state.trump === '♦') ? 'var(--chaos-red)' : '#fff';
        }

        // Отрисовка рук (Веер ИИ скрыт - Статичные 7 рубашек + динамика)
        function renderHands() {
            const pZone = document.getElementById('player-hand-visual');
            const eZone = document.getElementById('enemy-hand-visual');
            
            pZone.innerHTML = '';
            eZone.innerHTML = '';

            // Твои карты (Wanderer)
            vchf_state.pHand.sort((a, b) => a.val - b.val).forEach(card => {
                const cardEl = document.createElement('div');
                cardEl.className = `card ${card.suit === vchf_state.trump ? 'trump' : ''}`;
                cardEl.innerHTML = `<div>${card.rank}</div><div>${card.suit}</div>`;
                cardEl.style.color = (card.suit === '♥' || card.suit === '♦') ? 'var(--chaos-red)' : '#000';
                cardEl.onclick = () => handlePlayerAction(card);
                pZone.appendChild(cardEl);
            });

            // ИИ (Спарк) - Статичный веер 7 карт для "Тумана войны"
            // Но если карт < 3, веер начинает мерцать
            let fakeCount = vchf_state.eHand.length > 0 ? 7 : 0;
            if (vchf_state.eHand.length > 0 && vchf_state.eHand.length < 3) {
                // Особое состояние финала
            }

            for(let i=0; i < fakeCount; i++) {
                const shadow = document.createElement('div');
                shadow.className = 'enemy-card-shadow';
                if (vchf_state.eHand.length < 3) shadow.style.borderColor = 'var(--chaos-red)';
                eZone.appendChild(shadow);
            }
        }

        // Блуждающий Огонь (Таймер смены козыря)
        function startChaosTimer() {
            let timeLeft = 100;
            const step = 0.5; // Скорость сгорания
            
            const interval = setInterval(() => {
                if (vchf_state.phase === 'take_window') return; // Пауза при "Взять"

                timeLeft -= step;
                document.getElementById('vchf-progress').style.height = timeLeft + '%';

                if (timeLeft <= 0) {
                    vchf_state.oldTrump = vchf_state.trump;
                    let newTrump;
                    do {
                        newTrump = SUITS[Math.floor(Math.random() * SUITS.length)];
                    } while (newTrump === vchf_state.trump);
                    
                    vchf_state.trump = newTrump;
                    vchf_state.isMirrorRound = true;
                    updateTrumpUI();
                    renderHands();
                    timeLeft = 100;
                    
                    // Зеркальный удар активен 5 секунд
                    setTimeout(() => { vchf_state.isMirrorRound = false; }, 5000);
                }
            }, 100);
        }

        // Старт ритуала
        window.onload = () => {
            initDeck();
            dealCards();
            startChaosTimer();
            // Начало первого хода
            if (vchf_state.turn === 'enemy') setTimeout(enemyLogic, 1000);
        };
        // --- WINDOW 3: МОЗГ ИИ И ЛОГИКА БИТВЫ ---

        function handlePlayerAction(card) {
            if (vchf_state.turn !== 'player' || vchf_state.phase === 'take_window') return;

            // Логика атаки игрока
            if (vchf_state.phase === 'attack' || vchf_state.table.length === 0) {
                if (canAttack(card)) {
                    moveCardToTable(card, 'player', 'attack');
                    setTimeout(enemyLogic, 800);
                }
            } 
            // Логика защиты игрока
            else if (vchf_state.phase === 'defend') {
                if (canDefend(card)) {
                    moveCardToTable(card, 'player', 'defend');
                    vchf_state.phase = 'attack';
                    setTimeout(enemyLogic, 800);
                }
            }
        }

        function canAttack(card) {
            if (vchf_state.table.length === 0) return true; // Первый ход - любая
            if (vchf_state.table.length >= 12) return false; // Лимит 6 пар
            // Можно подкинуть только если такой номинал есть на столе
            return vchf_state.table.some(t => t.card.rank === card.rank);
        }

        function canDefend(card) {
            const lastAttack = [...vchf_state.table].reverse().find(t => t.type === 'attack');
            if (!lastAttack) return false;

            const a = lastAttack.card;
            // Если масти равны - карта должна быть старше
            if (card.suit === a.suit) return card.val > a.val;
            // Если карта козырь, а атака нет - бьет
            if (card.suit === vchf_state.trump && a.suit !== vchf_state.trump) return true;
            // "Зеркальный удар" (Призрачный козырь)
            if (vchf_state.isMirrorRound && card.suit === vchf_state.oldTrump) return true;
            
            return false;
        }

        // --- ЛОГИКА ИИ (SPARK ENGINE) ---
        function enemyLogic() {
            if (vchf_state.turn === 'player') {
                // ИИ ЗАЩИЩАЕТСЯ
                const lastAttack = [...vchf_state.table].reverse().find(t => t.type === 'attack');
                if (!lastAttack) return;

                const defenseCard = vchf_state.eHand.find(c => {
                    // Анти-кормление: ИИ не отдаст Туза за 6-ку, если Wanderer "выпрашивает"
                    if (c.val > 12 && lastAttack.card.val < 8) return false; 
                    
                    // Обычная логика защиты
                    if (c.suit === lastAttack.card.suit && c.val > lastAttack.card.val) return true;
                    if (c.suit === vchf_state.trump && lastAttack.card.suit !== vchf_state.trump) return true;
                    return false;
                });

                if (defenseCard) {
                    // 0.1% ШАНС НА ОШИБКУ (Человеческий фактор)
                    if (Math.random() < 0.001) { handleTake('enemy'); return; }
                    
                    moveCardToTable(defenseCard, 'enemy', 'defend');
                } else {
                    handleTake('enemy');
                }
            } else {
                // ИИ АТАКУЕТ
                if (vchf_state.table.length >= 12) { handleBito(); return; }
                
                let attackCard;
                if (vchf_state.table.length === 0) {
                    // Первый ход - заходит с мелкой, но иногда блефует
                    attackCard = vchf_state.eHand.sort((a,b) => a.val - b.val)[0];
                } else {
                    // Подкидывание по номиналу
                    attackCard = vchf_state.eHand.find(c => canAttack(c));
                }

                if (attackCard) {
                    moveCardToTable(attackCard, 'enemy', 'attack');
                } else {
                    handleBito();
                }
            }
            renderHands();
        }

        function handleTake(who = 'player') {
            vchf_state.phase = 'take_window';
            const status = document.getElementById('mainStatus');
            status.innerText = "ОКНО СБРОСА (5 СЕК)";
            
            // Запуск таймера "Вдогонку"
            let sec = 5;
            vchf_state.takeTimer = setInterval(() => {
                sec--;
                if (sec <= 0) {
                    clearInterval(vchf_state.takeTimer);
                    finalizeTake(who);
                }
            }, 1000);
        }

        function finalizeTake(who) {
            const tableCards = vchf_state.table.map(t => t.card);
            if (who === 'player') {
                vchf_state.pHand.push(...tableCards);
                vchf_state.turn = 'enemy';
            } else {
                vchf_state.eHand.push(...tableCards);
                vchf_state.turn = 'player';
            }
            vchf_state.table = [];
            vchf_state.phase = 'idle';
            document.getElementById('battle-table').innerHTML = '';
            renderHands();
            if (vchf_state.turn === 'enemy') setTimeout(enemyLogic, 1000);
        }

        function handleBito() {
            vchf_state.table = [];
            vchf_state.turn = vchf_state.turn === 'player' ? 'enemy' : 'player';
            document.getElementById('battle-table').innerHTML = '';
            renderHands();
            if (vchf_state.turn === 'enemy') setTimeout(enemyLogic, 1000);
        }

        function moveCardToTable(card, owner, type) {
            const hand = owner === 'player' ? vchf_state.pHand : vchf_state.eHand;
            const index = hand.findIndex(c => c.id === card.id);
            hand.splice(index, 1);

            vchf_state.table.push({ card, type });
            
            const tableEl = document.getElementById('battle-table');
            const cardEl = document.createElement('div');
            cardEl.className = `card ${card.suit === vchf_state.trump ? 'trump' : ''} ${type}`;
            cardEl.innerHTML = `<div>${card.rank}</div><div>${card.suit}</div>`;
            cardEl.style.color = (card.suit === '♥' || card.suit === '♦') ? 'var(--chaos-red)' : '#000';
            tableEl.appendChild(cardEl);
            
            renderHands();
        }
        // --- WINDOW 4: МАТРИЦА 42 И ФИНАЛ РИТУАЛА ---

        // Инициализация Матрицы 42 (Связь с Лотто по ссылке)
        function initMatrix42() {
            const container = document.createElement('div');
            container.id = 'matrix-overlay';
            container.style.cssText = `
                position: fixed; top: 100px; right: 20px;
                display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px;
                z-index: 100; pointer-events: none;
            `;
            document.body.appendChild(container);

            for (let i = 1; i <= 42; i++) {
                const node = document.createElement('div');
                node.className = 'sphere-node sleeping';
                node.id = `node-${i}`;
                node.innerText = i;
                node.style.cssText = `
                    width: 25px; height: 25px; border-radius: 50%;
                    background: #111; border: 1px solid #333;
                    font-size: 9px; display: flex; align-items: center;
                    justify-content: center; color: #444; transition: 0.5s;
                `;
                container.appendChild(node);
            }
        }

        // Обновление состояния сферы в реальном времени
        function updateMatrix(card, status) {
            const suitIdx = SUITS.indexOf(card.suit);
            const rankIdx = RANKS.indexOf(card.rank);
            const nodeIdx = (suitIdx * 9) + rankIdx + 1;
            const node = document.getElementById(`node-${nodeIdx}`);
            
            if (node) {
                node.className = 'sphere-node ' + status.toLowerCase();
                if (status === 'HOT') {
                    node.style.borderColor = 'var(--vchf-glow)';
                    node.style.boxShadow = 'var(--vchf-glow)';
                    node.style.color = '#fff';
                } else if (status === 'COLD') {
                    node.style.borderColor = 'var(--chaos-red)';
                    node.style.boxShadow = 'none';
                    node.style.color = '#fff';
                    node.style.opacity = '0.5';
                }
            }
        }

        // ПРОВЕРКА ФИНАЛА (Манифест Монолита)
        function checkWinCondition() {
            const p = vchf_state.pHand.length;
            const e = vchf_state.eHand.length;

            if (p === 0 && e === 0) {
                showEndGame("НИЧЬЯ — ХАОС СБАЛАНСИРОВАН");
            } else if (p === 0) {
                showEndGame("WANDERER, ТЫ ПОБЕДИЛ СИСТЕМУ! ДУХ VCHF С ТОБОЙ.");
            } else if (e === 0) {
                showEndGame("НУЛЕВОЙ ХАОС ДОМИНИРУЕТ. ПОПРОБУЙ СНОВА, БРОДЯГА.");
            }
        }

        function showEndGame(msg) {
            vchf_state.active = false;
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.9); z-index: 1000;
                display: flex; flex-direction: column; justify-content: center;
                align-items: center; font-size: 24px; color: #00ff00;
                text-align: center; font-family: 'Orbitron', sans-serif;
            `;
            overlay.innerHTML = `
                <div style="margin-bottom: 20px;">${msg}</div>
                <button class="vchf-btn" onclick="location.reload()">НАЧАТЬ РИТУАЛ ЗАНОВО</button>
            `;
            document.body.appendChild(overlay);
        }

        // Расширение функций из Window 3 для Матрицы
        const originalMove = moveCardToTable;
        moveCardToTable = function(card, owner, type) {
            originalMove(card, owner, type);
            updateMatrix(card, 'HOT');
            checkWinCondition();
        };

        const originalBito = handleBito;
        handleBito = function() {
            vchf_state.table.forEach(t => updateMatrix(t.card, 'COLD'));
            originalBito();
        };

        // Запуск Матрицы
        initMatrix42();

        // Финальный штрих: Ритуальный холст (Задний фон)
        const canvas = document.getElementById('ritual-canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        function drawRitualBG() {
            ctx.fillStyle = 'rgba(0,0,0,0.05)';
            ctx.fillRect(0,0, canvas.width, canvas.height);
            ctx.fillStyle = '#00ff0011';
            for(let i=0; i<20; i++) {
                ctx.beginPath();
                ctx.arc(Math.random()*canvas.width, Math.random()*canvas.height, 1, 0, Math.PI*2);
                ctx.fill();
            }
            requestAnimationFrame(drawRitualBG);
        }
        drawRitualBG();

        console.log("Движок VCHF загружен. Протокол 1.1 активен.");
    </script>
</body>
</html>
