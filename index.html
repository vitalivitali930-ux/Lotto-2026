<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VCHF Durak Round Monolith</title>
    <style>
        :root {
            --vchf-gold: #ffd700;
            --vchf-red: #ff4d4d;
            --vchf-green: #2ecc71;
            --vchf-black: #050000;
            --glass-border: rgba(255, 215, 0, 0.2);
            --bud-bg: rgba(15, 0, 5, 0.92);
        }

        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            background: var(--vchf-black); color: white; 
            font-family: 'Segoe UI', sans-serif; overflow: hidden; touch-action: none;
        }

        #monolith-engine {
            position: relative; width: 100vw; height: 100vh;
            background: radial-gradient(circle at center, #1a0005 0%, #000 100%);
            display: flex; flex-direction: column; align-items: center;
        }

        /* --- ТОТЕМ МАСТИ (КОЗЫРЬ) --- */
        #trump-totem {
            position: absolute; top: 20px; left: 20px;
            font-size: 60px; font-weight: bold;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
            z-index: 10; opacity: 0.8;
        }

        /* --- ЗОНА ПРОТИВНИКА (ТУМАН ВОЙНЫ) --- */
        #enemy-hand {
            height: 12%; width: 100%; display: flex; justify-content: center; 
            align-items: center; gap: 4px; padding-top: 10px;
        }

        /* --- ПОЛЕ БИТВЫ --- */
        #battle-zone {
            flex-grow: 1; width: 95%; display: grid; 
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(2, 1fr); gap: 10px;
            align-content: center; justify-items: center;
            perspective: 1000px;
        }

        /* --- БУТОН (НИЖНИЕ 35%) --- */
        #vchf-bud {
            position: absolute; bottom: 0; width: 100%; height: 35%;
            background: linear-gradient(to top, var(--bud-bg) 70%, rgba(5, 0, 0, 0) 100%);
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border-top: 1px solid var(--glass-border);
            display: flex; flex-direction: column; justify-content: flex-end;
            padding-bottom: 15px; z-index: 100;
        }

        .suit-lane {
            display: flex; gap: -12px; justify-content: center; height: 22%; margin-bottom: 2px;
        }

        /* --- КАРТЫ (MONOLITH DESIGN) --- */
        .v-card {
            width: 52px; height: 80px; background: white; color: black;
            border-radius: 5px; position: relative; display: flex;
            flex-direction: column; align-items: center; justify-content: center;
            font-weight: 900; font-size: 18px; cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.4);
            transition: transform 0.25s cubic-bezier(0.175, 0.885, 0.32, 1.275), box-shadow 0.2s;
            user-select: none;
        }

        .v-card.back { 
            background: #000 url('1771489965074(1).png') center/cover; 
            border: 1px solid #333; color: transparent;
        }

        .v-card.selected { 
            transform: translateY(-30px) scale(1.15); 
            border: 2px solid var(--vchf-gold);
            box-shadow: 0 0 25px var(--vchf-gold);
            z-index: 1001;
        }

        .v-card.red { color: var(--vchf-red); }

        .v-suit-mini { position: absolute; top: 4px; left: 4px; font-size: 12px; }

        /* --- ТАЙМЕР-СВЕТОФОР --- */
        #burning-line {
            position: absolute; top: 0; left: 0; width: 100%; height: 4px;
            background: var(--vchf-green); box-shadow: 0 0 10px var(--vchf-green);
            transition: background 0.5s, box-shadow 0.5s;
        }

        /* --- КОНТРОЛЫ --- */
        #hud-actions {
            position: absolute; right: 15px; bottom: 37%;
            display: flex; flex-direction: column; gap: 10px; z-index: 150;
        }

        .vchf-btn {
            background: rgba(0,0,0,0.85); color: var(--vchf-gold);
            border: 1px solid var(--vchf-gold); padding: 10px 18px;
            border-radius: 6px; font-size: 13px; font-weight: bold;
            cursor: pointer; text-transform: uppercase;
        }

        /* --- ИНИЦИАЦИЯ --- */
        #init-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: black; z-index: 2000; display: flex;
            flex-direction: column; align-items: center; justify-content: center;
        }
    </style>
</head>
<body>

<div id="monolith-engine">
    <div id="trump-totem"></div>
    <div id="enemy-hand"></div>
    
    <div id="battle-zone"></div>

    <div id="hud-actions">
        <button class="vchf-btn" onclick="takeAll()">ВЗЯТЬ</button>
        <button class="vchf-btn" onclick="bitTurn()">БИТО</button>
    </div>

    <div id="vchf-bud">
        <div id="burning-line"></div>
        <div id="lane-trump" class="suit-lane"></div>
        <div id="lane-1" class="suit-lane"></div>
        <div id="lane-2" class="suit-lane"></div>
        <div id="lane-3" class="suit-lane"></div>
    </div>
</div>

<div id="init-overlay">
    <h1 style="color:var(--vchf-gold); letter-spacing: 5px;">VCHF ROUND</h1>
    <div id="totem-spin" style="font-size: 100px;">♠</div>
</div>

<script>
    /* MACHINE_MEMORY_CORE [v.1.3] 
       Wanderer Agent Protocol 1.1
    */
    const SUITS = ['♠', '♣', '♥', '♦'];
    const RANKS = ['6','7','8','9','10','J','Q','K','A'];
    const VALS = {'6':6, '7':7, '8':8, '9':9, '10':10, 'J':11, 'Q':12, 'K':13, 'A':14};

    let pHand = [], eHand = [], field = [];
    let trumpSuit = '', activeIdx = null, isWait = false;
    let timerInt = null, timeLeft = 30;

    function startRitual() {
        const overlay = document.getElementById('init-overlay');
        const spinner = document.getElementById('totem-spin');
        let count = 0;
        
        const spin = setInterval(() => {
            spinner.innerText = SUITS[count % 4];
            spinner.style.color = (SUITS[count % 4] === '♥' || SUITS[count % 4] === '♦') ? 'red' : 'white';
            count++;
            if(count > 15) {
                clearInterval(spin);
                trumpSuit = spinner.innerText;
                document.getElementById('trump-totem').innerText = trumpSuit;
                document.getElementById('trump-totem').style.color = spinner.style.color;
                overlay.style.display = 'none';
                dealRound();
            }
        }, 120);
    }

    function dealRound() {
        // КРУГЛЫЙ ДУРАК: Сразу по 18 карт (36 / 2)
        let fullDeck = [];
        SUITS.forEach(s => RANKS.forEach(r => fullDeck.push({s, r, v: VALS[r]})));
        shuffle(fullDeck);
        
        pHand = fullDeck.splice(0, 18);
        eHand = fullDeck.splice(0, 18);
        
        renderState();
        startTimer();
    }

    function shuffle(a) {
        for (let i = a.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [a[i], a[j]] = [a[j], a[i]];
        }
    }

    function renderState() {
        renderEnemy();
        renderField();
        renderBud();
    }

    function renderEnemy() {
        const container = document.getElementById('enemy-hand');
        container.innerHTML = '';
        // Туман войны: количество карт видно, но номиналы скрыты
        eHand.forEach(() => {
            const c = document.createElement('div');
            c.className = 'v-card back';
            container.appendChild(c);
        });
    }

    function renderField() {
        const zone = document.getElementById('battle-zone');
        zone.innerHTML = '';
        field.forEach(c => {
            zone.appendChild(createCardUI(c));
        });
    }

    function renderBud() {
        const lanes = {
            trump: document.getElementById('lane-trump'),
            l1: document.getElementById('lane-1'),
            l2: document.getElementById('lane-2'),
            l3: document.getElementById('lane-3')
        };
        Object.values(lanes).forEach(l => l.innerHTML = '');

        const groups = { [trumpSuit]: [] };
        SUITS.filter(s => s !== trumpSuit).forEach((s, i) => groups[s] = []);
        pHand.forEach(c => groups[c.s].push(c));

        // Sort each group by value
        Object.keys(groups).forEach(s => groups[s].sort((a,b) => a.v - b.v));

        groups[trumpSuit].forEach(c => lanes.trump.appendChild(createCardUI(c, true)));
        
        const others = SUITS.filter(s => s !== trumpSuit);
        others.forEach((s, i) => {
            groups[s].forEach(c => lanes['l' + (i+1)].appendChild(createCardUI(c, true)));
        });
    }

    function createCardUI(card, interactive = false) {
        const div = document.createElement('div');
        div.className = 'v-card';
        if (card.s === '♥' || card.s === '♦') div.classList.add('red');
        
        div.innerHTML = `<span class="v-suit-mini">${card.s}</span><span>${card.r}</span>`;

        if (interactive) {
            const idx = pHand.indexOf(card);
            if (activeIdx === idx) div.classList.add('selected');
            div.onclick = () => handleTap(idx);
        }
        return div;
    }
    // --- ИГРОВАЯ МЕХАНИКА (WINDOW 2) ---

    function handleTap(idx) {
        if (isWait) return;

        // DOUBLE_TAP_CONFIRM: Защита от случайного хода [cite: 2026-02-23]
        if (activeIdx === idx) {
            confirmMove(idx);
        } else {
            activeIdx = idx;
            // Визуальный отклик - золотое свечение (Highlight_Golden_VCHF)
            renderState();
        }
    }

    function confirmMove(idx) {
        const card = pHand.splice(idx, 1)[0];
        field.push(card);
        activeIdx = null;
        isWait = true; // Блокировка на время раздумий ИИ

        renderState();
        stopTimer();

        // Имитация "человеческого" мышления ИИ (2s to 28s) [cite: 2026-02-23]
        const thoughtDelay = 1000 + Math.random() * 2000; 
        setTimeout(enemyLogic, thoughtDelay);
    }

    function enemyLogic() {
        if (field.length % 2 === 0) {
            // ИИ в режиме атаки (если поле чистое)
            isWait = false;
            startTimer();
            return;
        }

        const attackCard = field[field.length - 1];
        
        // Поиск карт для защиты
        let defenseOptions = eHand.filter(c => 
            (c.s === attackCard.s && c.v > attackCard.v) || 
            (c.s === trumpSuit && attackCard.s !== trumpSuit)
        );

        // Сортировка по возрастанию, чтобы не тратить Тузов зря
        defenseOptions.sort((a,b) => a.v - b.v);

        // ПСИХОЛОГИЯ 15% ОШИБКИ: ИИ может "не заметить" карту [cite: 2026-02-22]
        const hasBrainFade = Math.random() < 0.15;

        if (defenseOptions.length > 0 && !hasBrainFade) {
            const defCard = defenseOptions[0];
            const eIdx = eHand.indexOf(defCard);
            field.push(eHand.splice(eIdx, 1)[0]);
            console.log("ИИ успешно защитился");
        } else {
            // ИИ забирает карты (Silent Action Flow) [cite: 2026-02-23]
            console.log("ИИ берет карты: ошибка или нет карт");
            eHand.push(...field);
            field = [];
        }

        isWait = false;
        renderState();
        checkVictory();
        startTimer();
    }

    // --- СИСТЕМА ТАЙМЕРА (BURNING LINE) ---

    function startTimer() {
        stopTimer();
        timeLeft = 30;
        const line = document.getElementById('burning-line');
        
        timerInt = setInterval(() => {
            timeLeft -= 0.1;
            const percent = (timeLeft / 30) * 100;
            line.style.width = percent + '%';

            // Transition: Green -> Yellow -> Red [cite: 2026-02-23]
            if (percent > 50) {
                line.style.background = 'var(--vchf-green)';
                line.style.boxShadow = '0 0 10px var(--vchf-green)';
            } else if (percent > 20) {
                line.style.background = 'gold';
                line.style.boxShadow = '0 0 10px gold';
            } else {
                line.style.background = 'var(--vchf-red)';
                line.style.boxShadow = '0 0 15px var(--vchf-red)';
            }

            if (timeLeft <= 0) {
                autoPenalty();
            }
        }, 100);
    }

    function stopTimer() {
        if (timerInt) clearInterval(timerInt);
        const line = document.getElementById('burning-line');
        line.style.width = '100%';
        line.style.background = 'var(--vchf-green)';
    }

    function autoPenalty() {
        // Critical Action Defense: Auto Take [cite: 2026-02-23]
        console.log("Таймер истек: Принудительный забор");
        takeAll();
    }

    // --- ГЛОБАЛЬНЫЕ ДЕЙСТВИЯ ---

    function takeAll() {
        if (field.length === 0) return;
        pHand.push(...field);
        field = [];
        activeIdx = null;
        renderState();
        startTimer();
    }

    function bitTurn() {
        // "Бито" возможно только если на столе четное кол-во карт
        if (field.length === 0 || field.length % 2 !== 0) return;
        
        field = []; // В Круглом Дураке бито просто уходит из игры
        activeIdx = null;
        renderState();
        checkVictory();
        startTimer();
    }

    function checkVictory() {
        if (pHand.length === 0) {
            alert("Wanderer победил! Ритуал завершен.");
            location.reload();
        } else if (eHand.length === 0) {
            alert("ИИ победил. Попробуй еще раз.");
            location.reload();
        }
    }

    // Запуск Ритуала
    window.onload = startRitual;

</script>
</body>
</html>
