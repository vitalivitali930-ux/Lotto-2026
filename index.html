<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VCHF Durak Grandmaster</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --cherry-velvet: radial-gradient(circle at center, #800020 0%, #2a0005 65%, #000 100%);
            --card-back-grad: radial-gradient(circle, #000 25%, #5a0010 100%);
            --gold: #d4af37;
            --gold-glow: 0 0 15px rgba(212, 175, 55, 0.4);
        }

        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: var(--cherry-velvet); overflow: hidden; font-family: 'Orbitron', sans-serif; color: white; }

        /* Освещение: Эффект старой лампы над столом */
        body::after {
            content: ''; position: fixed; top: 35%; left: 50%; transform: translate(-50%, -50%);
            width: 90vh; height: 90vh; background: radial-gradient(circle, rgba(255, 220, 100, 0.1) 0%, transparent 75%);
            pointer-events: none; z-index: 5;
        }

        #game-ui { position: relative; width: 100%; height: 100vh; display: flex; flex-direction: column; justify-content: space-between; padding: 15px; z-index: 10; }

        /* Колода слева: Твой запрос */
        #deck-container { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); width: 70px; height: 100px; }
        .trump-base { position: absolute; width: 65px; height: 95px; background: #fff; border-radius: 5px; transform: rotate(90deg) translate(20px, 15px); border: 1px solid var(--gold); color: #000; font-weight: 900; padding: 5px; display: flex; flex-direction: column; justify-content: space-between; font-size: 11px; }
        .deck-stack { position: absolute; width: 65px; height: 95px; background: var(--card-back-grad); border-radius: 5px; border: 1.5px solid var(--gold); z-index: 2; display: flex; align-items: center; justify-content: center; box-shadow: -4px 4px 15px #000; }
        .deck-stack img { width: 85%; filter: drop-shadow(0 0 3px rgba(0,0,0,0.5)); }

        /* Зоны рук */
        .hand { display: flex; justify-content: center; width: 100%; height: 120px; gap: -20px; }
        #enemy-hand { transform: rotate(180deg) scale(0.9); opacity: 0.8; }
        #player-hand { transform: translateY(5px); }

        /* Поле боя */
        #battle-area { flex-grow: 1; display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; align-content: center; max-width: 450px; margin: auto; }

        /* Карты */
        .card { width: 72px; height: 105px; background: #fff; border-radius: 6px; color: #000; display: flex; flex-direction: column; justify-content: space-between; padding: 5px; font-weight: 900; box-shadow: 0 10px 25px rgba(0,0,0,0.7); border: 1px solid #ccc; transition: 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28); position: relative; }
        .card.red { color: #cc0000; }
        .card.back { background: var(--card-back-grad); border: 1.5px solid var(--gold); }
        .card.back img { width: 80%; margin: auto; display: block; }
        #player-hand .card:hover { transform: translateY(-30px) scale(1.1); z-index: 100; border-color: var(--gold); box-shadow: var(--gold-glow); }

        /* Кнопки управления: Справа под рукой */
        #controls { position: absolute; right: 15px; bottom: 140px; display: flex; flex-direction: column; gap: 12px; }
        .btn-vchf { background: rgba(0,0,0,0.85); border: 1.5px solid var(--gold); color: var(--gold); padding: 14px 20px; border-radius: 5px; font-family: 'Orbitron'; font-size: 11px; font-weight: 900; cursor: pointer; text-transform: uppercase; letter-spacing: 2px; transition: 0.2s; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        .btn-vchf:active { transform: scale(0.95); background: var(--gold); color: black; }
        .btn-vchf:disabled { opacity: 0.2; filter: grayscale(1); }

        #status-msg { position: absolute; top: 15px; width: 100%; text-align: center; color: var(--gold); font-size: 10px; letter-spacing: 5px; opacity: 0.7; }
    </style>
</head>
<body>

<div id="game-ui">
    <div id="status-msg">STRATEGY ENGINE READY</div>

    <div id="deck-container">
        <div id="trump-slot" class="trump-base"></div>
        <div id="deck-visual" class="deck-stack"><img src="1771489965074(1).png"></div>
    </div>

    <div id="enemy-hand" class="hand"></div>
    <div id="battle-area"></div>

    <div id="controls">
        <button id="btn-action" class="btn-vchf" onclick="game.handleAction()">ХОД</button>
        <button class="btn-vchf" style="border-color:#555; color:#777" onclick="location.reload()">MENU</button>
    </div>

    <div id="player-hand" class="hand"></div>
</div>

<script>
/** * МАНИФЕСТ МОНОЛИТА. Искра (Spark) для Wanderer.
 * [2026-02-26] Полная сборка с ИИ-стратегией.
 */
const tg = window.Telegram.WebApp;
const suits = ['♠', '♣', '♥', '♦'], vals = ['6','7','8','9','10','J','Q','K','A'];
const pwr = {'6':6,'7':7,'8':8,'9':9,'10':10,'J':11,'Q':12,'K':13,'A':14};

const game = {
    deck: [], pHand: [], eHand: [], table: [], trump: null, isPlayerAttack: true,

    init() {
        this.deck = [];
        suits.forEach(s => vals.forEach(v => this.deck.push({s, v, red: (s==='♥'||s==='♦')})));
        this.deck.sort(() => Math.random() - 0.5);
        this.trump = this.deck[0];
        this.refill();
        this.render();
        this.setStatus(this.isPlayerAttack ? "ВАШ ХОД" : "ВРАГ ХОДИТ");
    },

    refill() {
        while(this.pHand.length < 6 && this.deck.length > 0) this.pHand.push(this.deck.pop());
        while(this.eHand.length < 6 && this.deck.length > 0) this.eHand.push(this.deck.pop());
    },

    render() {
        // Рендер козыря
        const ts = document.getElementById('trump-slot');
        ts.innerHTML = `<div>${this.trump.s}</div><div style="font-size:20px">${this.trump.v}</div>`;
        if(this.trump.red) ts.style.color = '#cc0000';
        document.getElementById('deck-visual').style.display = this.deck.length > 1 ? 'flex' : 'none';

        // Рендер рук
        const ph = document.getElementById('player-hand'); ph.innerHTML = '';
        this.pHand.sort((a,b) => pwr[a.v] - pwr[b.v]).forEach((c, i) => {
            const el = this.createCardUI(c);
            el.onclick = () => this.playerPlay(i);
            ph.appendChild(el);
        });

        const eh = document.getElementById('enemy-hand'); eh.innerHTML = '';
        this.eHand.forEach(() => eh.appendChild(this.createCardUI(null, true)));

        // Рендер поля боя
        const ba = document.getElementById('battle-area'); ba.innerHTML = '';
        this.table.forEach(pair => {
            const wrapper = document.createElement('div'); wrapper.style.position = 'relative';
            wrapper.appendChild(this.createCardUI(pair.at));
            if(pair.df) {
                const df = this.createCardUI(pair.df);
                df.style.position = 'absolute'; df.style.top = '18px'; df.style.left = '12px'; df.style.zIndex = '10';
                wrapper.appendChild(df);
            }
            ba.appendChild(wrapper);
        });
        this.updateBtnUI();
    },

    createCardUI(c, isBack = false) {
        const d = document.createElement('div');
        d.className = 'card' + (isBack ? ' back' : (c.red ? ' red' : ''));
        if(isBack) d.innerHTML = `<img src="1771489965074(1).png">`;
        else d.innerHTML = `<div>${c.s}</div><div style="font-size:22px;align-self:center">${c.v}</div><div style="align-self:flex-end">${c.s}</div>`;
        return d;
    },

    playerPlay(idx) {
        const c = this.pHand[idx];
        if(this.isPlayerAttack) {
            if(this.table.length >= 6) return;
            if(this.table.length > 0) {
                const allowed = this.table.flatMap(p => [p.at.v, p.df?.v]).filter(Boolean);
                if(!allowed.includes(c.v)) return;
            }
            this.table.push({at: c, df: null});
            this.pHand.splice(idx, 1);
            this.render();
            setTimeout(() => this.aiDefend(), 600);
        } else {
            const target = this.table.find(p => !p.df);
            if(target && this.canBeat(c, target.at)) {
                target.df = c;
                this.pHand.splice(idx, 1);
                this.render();
                setTimeout(() => this.aiAttack(), 800);
            }
        }
    },

    canBeat(c1, c2) {
        if(c1.s === c2.s) return pwr[c1.v] > pwr[c2.v];
        return c1.s === this.trump.s;
    },

    // ШАХМАТНЫЙ ИНТЕЛЛЕКТ ИИ
    aiDefend() {
        const p = this.table.find(p => !p.df);
        if(!p) return;
        
        let candidates = this.eHand.filter(c => this.canBeat(c, p.at));
        if(candidates.length > 0) {
            // Стратегия: отбиться самой слабой картой, жалея козыри
            candidates.sort((a,b) => {
                const at = a.s === this.trump.s, bt = b.s === this.trump.s;
                if(at && !bt) return 1; if(!at && bt) return -1;
                return pwr[a.v] - pwr[b.v];
            });
            p.df = this.eHand.splice(this.eHand.indexOf(candidates[0]), 1)[0];
        } else {
            this.setStatus("ВРАГ БЕРЕТ КАРТЫ");
        }
        this.render();
    },

    aiAttack() {
        if(!this.isPlayerAttack) {
            const onT = this.table.flatMap(p => [p.at.v, p.df?.v]).filter(Boolean);
            let candidates = this.eHand.filter(c => onT.length === 0 || onT.includes(c.v));
            
            if(candidates.length > 0 && this.table.length < 6) {
                // Стратегия: нападать мелочью, беречь козыри
                candidates.sort((a,b) => (a.s === this.trump.s) - (b.s === this.trump.s) || pwr[a.v] - pwr[b.v]);
                this.table.push({at: this.eHand.splice(this.eHand.indexOf(candidates[0]), 1)[0], df: null});
                this.render();
            } else {
                this.setStatus("ВРАГ: БИТО");
                this.render();
            }
        }
    },

    handleAction() {
        const btn = document.getElementById('btn-action');
        if(btn.innerText === "БИТО") {
            this.table = []; this.refill();
            this.isPlayerAttack = !this.isPlayerAttack;
            this.setStatus(this.isPlayerAttack ? "ВАШ ХОД" : "ВРАГ ХОДИТ");
            if(!this.isPlayerAttack) setTimeout(() => this.aiAttack(), 600);
        } else if(btn.innerText === "ВЗЯТЬ") {
            const all = this.table.flatMap(p => [p.at, p.df]).filter(Boolean);
            if(this.isPlayerAttack) this.eHand.push(...all); else this.pHand.push(...all);
            this.table = []; this.refill();
            if(!this.isPlayerAttack) setTimeout(() => this.aiAttack(), 600);
        }
        this.render();
    },

    updateBtnUI() {
        const b = document.getElementById('btn-action');
        const hasUnbeaten = this.table.some(p => !p.df);
        if(this.isPlayerAttack) {
            b.innerText = (this.table.length > 0 && !hasUnbeaten) ? "БИТО" : "ХОД";
            b.disabled = hasUnbeaten && this.table.length > 0;
        } else {
            b.innerText = hasUnbeaten ? "ВЗЯТЬ" : "БИТО";
        }
    },

    setStatus(s) { document.getElementById('status-msg').innerText = s; tg.HapticFeedback.impactOccurred('medium'); }
};

game.init();
</script>
</body>
</html>
