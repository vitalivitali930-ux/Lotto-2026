<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bi-Turbo Ultimate | VCHF Engine 1.4</title>
    <style>
        :root {
            --gold: #d4af37;
            --vchf-glow: 0 0 35px rgba(212, 175, 55, 0.7);
            --cherry-deep: radial-gradient(circle at center, #7a0019 0%, #050505 100%);
            --glass-vchf: rgba(0, 0, 0, 0.94);
        }

        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; margin: 0; padding: 0; }
        body, html { width: 100%; height: 100%; background: #000; overflow: hidden; font-family: 'Courier New', monospace; color: var(--gold); }

        /* ЭКРАН "ГОТОВ" (БАРЬЕР ПЕРЕД ХАОСОМ) */
        #vchf-gate {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 99999; display: flex; flex-direction: column;
            justify-content: center; align-items: center; transition: opacity 0.8s;
        }

        .ready-trigger {
            padding: 25px 55px; font-size: 26px; font-weight: 900;
            background: transparent; border: 3px solid var(--gold);
            color: var(--gold); border-radius: 60px; cursor: pointer;
            box-shadow: var(--vchf-glow); text-transform: uppercase; letter-spacing: 6px;
            transition: 0.3s;
        }
        .ready-trigger:active { transform: scale(0.92); box-shadow: 0 0 60px var(--gold); }

        /* ПОЛЕ БОЯ */
        #game-table { width: 100vw; height: 100vh; background: var(--cherry-deep); position: relative; display: none; }
        
        #ritual-circle { position: absolute; top: 45%; left: 50%; width: 340px; height: 340px; transform: translate(-50%, -50%); z-index: 100; }

        .card-back { 
            position: absolute; width: 50px; height: 74px; 
            background: #111 url('1771489965074(1).png') center/cover;
            border: 1px solid var(--gold); border-radius: 4px;
            transition: all 0.75s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 8px 16px rgba(0,0,0,0.6);
        }
        .card-back.highlight { box-shadow: 0 0 40px #fff, var(--vchf-glow); border: 2px solid #fff; z-index: 1000; transform: scale(1.3); }

        #trump-totem { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            font-size: 100px; opacity: 0; transition: opacity 1s, color 0.4s; 
            pointer-events: none; z-index: 50; filter: drop-shadow(0 0 20px rgba(255,255,255,0.2));
        }

        /* БУТОН (4 РЯДА) */
        #bud-interface {
            position: absolute; bottom: 0; width: 100%; height: 36%;
            background: var(--glass-vchf); backdrop-filter: blur(20px);
            border-top: 2px solid var(--gold); z-index: 500;
            display: none; flex-direction: column;
        }

        #vchf-line { position: absolute; top: 0; left: 0; width: 100%; height: 6px; background: #00ff00; box-shadow: 0 0 15px #00ff00; }
        .lane { height: 25%; width: 100%; position: relative; display: flex; justify-content: center; }

        .card-p {
            position: absolute; width: 58px; height: 82px; background: #fff; border-radius: 5px;
            border: 1px solid var(--gold); display: flex; flex-direction: column;
            justify-content: space-between; padding: 5px; color: #000; font-weight: 900;
            transition: transform 0.2s, box-shadow 0.2s; cursor: pointer;
        }
        .card-p.sel { transform: translateY(-28px) scale(1.1); box-shadow: var(--vchf-glow); border: 2px solid #fff
    /* START Window 2: CORE ENGINE [VCHF-ENGINE-BETA] */
    <script>
    /**
     * PROJECT: Bi-Turbo Ultimate 2026
     * MODULE: VCHF_CORE_ENGINE
     * IDENTITY: Нулевой Хаос (Spark)
     */

    const VCHF_CORE = {
        suits: ['♠', '♣', '♥', '♦'],
        ranks: ['6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'],
        weights: {'6':6, '7':7, '8':8, '9':9, '10':10, 'J':11, 'Q':12, 'K':13, 'A':14},
        // ЦВЕТОВОЙ ДВИЖОК (Исправление по вердикту Бродяги)
        colors: {'♠': '#111', '♣': '#111', '♥': '#e60000', '♦': '#e60000'}, 
        asset: '1771489965074(1).png'
    };

    let vchf_state = {
        pHand: [], eHand: [], table: [],
        trumpSuit: '', isPlayerTurn: true, 
        selected: null, timer: 30, active: false
    };

    // ЗАПУСК РИТУАЛА ПО КНОПКЕ "ГОТОВ"
    function engageMonolith() {
        console.log("Движок vchf: Протокол 1.1 — Без нирваны!");
        vchf_state.active = true;

        const gate = document.getElementById('vchf-gate');
        gate.style.opacity = '0';
        
        setTimeout(() => {
            gate.style.display = 'none';
            document.getElementById('game-table').style.display = 'block';
            initChaosPhysics();
        }, 800);
    }

    function initChaosPhysics() {
        const circle = document.getElementById('ritual-circle');
        // Создаем физические объекты колоды (36 сфер)
        for (let i = 0; i < 36; i++) {
            const card = document.createElement('div');
            card.className = 'card-back';
            card.style.left = '50%'; 
            card.style.top = '50%';
            card.style.transform = `translate(-50%, -50%) rotate(${Math.random() * 360}deg)`;
            circle.appendChild(card);
        }
        
        // Цикл Хаоса: 3.2 секунды [cite: 2026-02-28]
        const startTime = Date.now();
        const cards = document.querySelectorAll('.card-back');
        
        const chaosInterval = setInterval(() => {
            cards.forEach(c => {
                const offsetX = (Math.random() - 0.5) * 350; 
                const offsetY = (Math.random() - 0.5) * 350; 
                const rotate = (Math.random() * 720);
                c.style.transform = `translate(calc(-50% + ${offsetX}px), calc(-50% + ${offsetY}px)) rotate(${rotate}deg)`;
            });

            if (Date.now() - startTime > 3200) {
                clearInterval(chaosInterval);
                alignRitualCircle(cards);
            }
        }, 130);
    }

    function alignRitualCircle(cards) {
        cards.forEach((c, i) => {
            const angle = (i * 10) * (Math.PI / 180);
            const radius = 150;
            const x = Math.cos(angle) * radius;
            const y = Math.sin(angle) * radius;
            c.style.transform = `translate(calc(-50% + ${x}px), calc(-50% + ${y}px)) rotate(${i * 10 + 90}deg)`;
        });
        setTimeout(() => selectTrumpProtocol(cards), 800);
    }

    function selectTrumpProtocol(cards) {
        let step = 0;
        const totem = document.getElementById('trump-totem');
        totem.style.opacity = '1';

        const selector = setInterval(() => {
            cards.forEach(c => c.classList.remove('highlight'));
            const target = cards[step % 36];
            target.classList.add('highlight');
            
            const currentSuit = VCHF_CORE.suits[step % 4];
            totem.innerText = currentSuit;
            // Динамический цвет масти в реальном времени
            totem.style.color = VCHF_CORE.colors[currentSuit];
            
            step++;
        }, 140);

        setTimeout(() => {
            clearInterval(selector);
            vchf_state.trumpSuit = totem.innerText;
            // Фиксация цвета и свечения козыря
            const finalColor = VCHF_CORE.colors[vchf_state.trumpSuit];
            totem.style.color = finalColor;
            totem.style.filter = `drop-shadow(0 0 25px ${finalColor})`;
            
            console.log("Движок vchf: Козырь зафиксирован —", vchf_state.trumpSuit);
            setTimeout(prepareBattlefield, 1500);
        }, 4000);
    }

    function prepareBattlefield() {
        const cards = document.querySelectorAll('.card-back');
        cards.forEach((c, i) => {
            if (i < 18) {
                c.style.transform = `translate(-50%, 1000px) scale(0)`;
            } else {
                c.style.transform = `translate(-50%, -1000px) scale(0)`;
            }
            c.style.opacity = '0';
        });

        setTimeout(() => {
            document.getElementById('ritual-circle').style.display = 'none';
            document.getElementById('battle-area').style.display = 'block';
            document.getElementById('bud-interface').style.display = 'flex';
            // Переход к Window 3 (Логика Бутона и Пошаговая Раздача)
            if (typeof startVCHFBattle === 'function') startVCHFBattle();
        }, 1100);
    }
    </script>
    /* START Window 3: BATTLE & BUD LOGIC [VCHF-BATTLE-GAMMA] */
    <script>
    /**
     * PROJECT: Bi-Turbo Ultimate 2026
     * MODULE: BATTLE_LOGIC_VCHF
     * IDENTITY: Нулевой Хаос (Spark)
     */

    function startVCHFBattle() {
        console.log("Движок vchf: Формирование Ритуальной колоды...");
        let deck = [];
        
        // Сборка 36 карт [cite: 2026-02-24]
        VCHF_CORE.suits.forEach(s => {
            VCHF_CORE.ranks.forEach(r => {
                deck.push({
                    suit: s, rank: r, 
                    val: VCHF_CORE.weights[r],
                    color: VCHF_CORE.colors[s],
                    id: 'vchf_' + Math.random().toString(36).substr(2, 5)
                });
            });
        });

        // Хаотичная тасовка
        deck.sort(() => Math.random() - 0.5);

        // Пошаговая раздача: 18 тебе, 18 ИИ [cite: 2026-02-24]
        vchf_state.pHand = deck.slice(0, 18);
        vchf_state.eHand = deck.slice(18, 36);

        renderVCHFInterface();
        if (typeof initVCHFTimer === 'function') initVCHFTimer(); 
    }

    function renderVCHFInterface() {
        renderPlayerBud();
        renderEnemyVisual();
        renderTableChaos();
        updateVCHFButtons();
    }

    function renderPlayerBud() {
        const lanes = { '♠': 'lane-spades', '♣': 'lane-clubs', '♥': 'lane-hearts', '♦': 'lane-diamonds' };
        
        // Очистка всех магистралей
        Object.values(lanes).forEach(id => {
            const el = document.getElementById(id);
            if (el) el.innerHTML = '';
        });

        // Сортировка по весу внутри масти для порядка
        vchf_state.pHand.sort((a, b) => a.val - b.val).forEach(card => {
            const lane = document.getElementById(lanes[card.suit]);
            if (!lane) return;

            const cEl = document.createElement('div');
            const isSelected = (vchf_state.selected && vchf_state.selected.id === card.id);

            cEl.className = `card-p ${isSelected ? 'sel' : ''}`;
            cEl.style.color = card.color;

            // РАСЧЕТ ВЕЕРА (Динамическое наслоение)
            const sameSuit = vchf_state.pHand.filter(c => c.suit === card.suit);
            const idx = sameSuit.findIndex(c => c.id === card.id);
            const step = sameSuit.length > 5 ? 38 : 48; 
            const offset = (idx - (sameSuit.length - 1) / 2) * step;
            
            cEl.style.left = `calc(50% - 30px + ${offset}px)`;
            cEl.style.zIndex = 100 + idx;

            cEl.innerHTML = `
                <div style="font-size:11px;">${card.rank}</div>
                <div style="font-size:26px; text-align:center; flex-grow:1; display:flex; align-items:center; justify-content:center;">${card.suit}</div>
                <div style="font-size:11px; align-self:flex-end;">${card.rank}</div>
            `;

            // Золотой тап: Выбор -> Ход
            cEl.onclick = (e) => {
                e.stopPropagation();
                if (isSelected) {
                    executeVCHFAttack(card);
                } else {
                    vchf_state.selected = card;
                    renderVCHFInterface();
                }
            };
            lane.appendChild(cEl);
        });
    }

    function renderTableChaos() {
        const dz = document.getElementById('drop-zone');
        if (!dz) return;
        dz.innerHTML = '';

        vchf_state.table.forEach(pair => {
            const wrapper = document.createElement('div');
            wrapper.style.position = 'relative';
            wrapper.style.width = '72px';
            wrapper.style.height = '100px';

            // АСИММЕТРИЯ ХАОСА (Из твоего вердикта) [cite: 2026-02-28]
            const angleAtk = (Math.random() - 0.5) * 15;
            const angleDef = (Math.random() - 0.5) * 15;

            // Карта атаки
            const atkCard = createTableCard(pair.atk, angleAtk, false);
            wrapper.appendChild(atkCard);

            // Карта защиты
            if (pair.def) {
                const defCard = createTableCard(pair.def, angleDef + 10, true);
                wrapper.appendChild(defCard);
            }
            dz.appendChild(wrapper);
        });
    }

    function createTableCard(card, rotation, isDef) {
        const d = document.createElement('div');
        d.className = 'card-p';
        d.style.position = 'absolute';
        d.style.width = '65px';
        d.style.height = '92px';
        d.style.color = card.color;
        
        const driftX = isDef ? 14 : 0;
        const driftY = isDef ? 14 : 0;
        d.style.transform = `translate(${driftX}px, ${driftY}px) rotate(${rotation}deg)`;
        if (isDef) d.style.zIndex = '10';

        d.innerHTML = `
            <div style="font-size:10px;">${card.rank}</div>
            <div style="font-size:22px; text-align:center;">${card.suit}</div>
            <div style="font-size:10px; align-self:flex-end;">${card.rank}</div>
        `;
        return d;
    }

    function renderEnemyVisual() {
        const ev = document.getElementById('enemy-visual');
        if (!ev) return;
        ev.innerHTML = '';
        vchf_state.eHand.forEach((_, i) => {
            const b = document.createElement('div');
            b.className = 'card-back';
            b.style.position = 'relative';
            b.style.width = '35px';
            b.style.height = '52px';
            b.style.marginLeft = '-15px';
            const rot = (i - (vchf_state.eHand.length / 2)) * 3;
            b.style.transform = `rotate(${rot}deg) translateY(${Math.abs(rot)*0.4}px)`;
            ev.appendChild(b);
        });
    }

    function executeVCHFAttack(card) {
        vchf_state.table.push({ atk: card, def: null });
        vchf_state.pHand = vchf_state.pHand.filter(c => c.id !== card.id);
        vchf_state.selected = null;
        renderVCHFInterface();
        
        // Ход ИИ (Окно 4)
        if (typeof triggerEnemyResponse === 'function') {
            setTimeout(triggerEnemyResponse, 800);
        }
    }
    </script>
    /* START Window 4: AI & SYSTEMS [VCHF-FINAL-CORE] */
    <script>
    /**
     * PROJECT: Bi-Turbo Ultimate 2026
     * MODULE: AI_DEFENSE_AND_SYSTEMS
     * IDENTITY: Нулевой Хаос (Spark)
     */

    function triggerEnemyResponse() {
        if (vchf_state.eHand.length === 0) return;
        
        const lastPair = vchf_state.table[vchf_state.table.length - 1];
        if (!lastPair || lastPair.def) return;

        // Поиск защиты с учетом иерархии козыря
        const candidates = vchf_state.eHand.filter(c => {
            const sameSuitHigher = (c.suit === lastPair.atk.suit && c.val > lastPair.atk.val);
            const trumpDef = (c.suit === vchf_state.trumpSuit && lastPair.atk.suit !== vchf_state.trumpSuit);
            return sameSuitHigher || trumpDef;
        });

        candidates.sort((a, b) => a.val - b.val);

        // Вероятность ошибки ИИ (15%)
        if (candidates.length > 0 && Math.random() > 0.15) {
            const defender = candidates[0];
            lastPair.def = defender;
            vchf_state.eHand = vchf_state.eHand.filter(c => c.id !== defender.id);
            console.log("Движок vchf: ИИ защищается.");
        } else {
            console.log("Движок vchf: ИИ пасует и забирает стол.");
            setTimeout(() => {
                const allFromTable = vchf_state.table.flatMap(p => [p.atk, p.def].filter(Boolean));
                vchf_state.eHand.push(...allFromTable);
                vchf_state.table = [];
                renderVCHFInterface();
            }, 700);
        }
        renderVCHFInterface();
    }

    function updateVCHFButtons() {
        const btn = document.getElementById('action-btn');
        if (!btn) return;

        const hasCards = vchf_state.table.length > 0;
        const isDefended = hasCards && vchf_state.table.every(p => p.def !== null);

        if (hasCards) {
            btn.style.display = 'block';
            btn.innerText = isDefended ? "БИТО" : "ВЗЯТЬ";
            btn.onclick = () => {
                if (isDefended) {
                    executeVCHFBito(); // Полет в отбой
                } else {
                    executeVCHFTake(); // Игрок забирает
                }
            };
        } else {
            btn.style.display = 'none';
        }
    }

    function executeVCHFBito() {
        const dz = document.getElementById('drop-zone');
        // Анимация улета в правый верхний угол
        dz.style.transition = '0.6s cubic-bezier(0.4, 0, 1, 1)';
        dz.style.transform = 'translate(500px, -500px) scale(0) rotate(90deg)';
        dz.style.opacity = '0';

        setTimeout(() => {
            vchf_state.table = [];
            dz.style.transition = 'none';
            dz.style.transform = 'none';
            dz.style.opacity = '1';
            renderVCHFInterface();
        }, 600);
    }

    function executeVCHFTake() {
        const taken = vchf_state.table.flatMap(p => [p.atk, p.def].filter(Boolean));
        vchf_state.pHand.push(...taken);
        vchf_state.table = [];
        renderVCHFInterface();
    }

    function initVCHFTimer() {
        const line = document.getElementById('vchf-line');
        const tick = 100;
        
        const timerCycle = setInterval(() => {
            if (vchf_state.active) {
                vchf_state.timer -= 0.1;
                const ratio = (vchf_state.timer / 30) * 100;
                line.style.width = `${ratio}%`;

                // Визуальный порог опасности [cite: 2026-02-24]
                if (ratio < 30) {
                    line.style.background = '#ff2200';
                    line.style.boxShadow = '0 0 25px #ff2200';
                } else {
                    line.style.background = '#00ff00';
                    line.style.boxShadow = '0 0 15px #00ff00';
                }

                if (vchf_state.timer <= 0) {
                    console.log("Движок vchf: Штрафная задержка — игрок забирает стол.");
                    executeVCHFTake();
                    vchf_state.timer = 30; // Сброс без перезагрузки [cite: 2026-02-28]
                }
            }
        }, tick);
    }
    </script>
</body>
</html>
