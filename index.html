<!DOCTYPE html>
<html lang="ru" translate="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VCHF Durak Elite - Global Lotto Tool</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --cherry-velvet: radial-gradient(circle at center, #800020 0%, #4a0010 50%, #050505 100%);
            --gold: #d4af37;
            --gold-glow: 0 0 15px rgba(212, 175, 55, 0.5);
            --card-w: 75px;
            --card-h: 110px;
        }

        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }

        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background: var(--cherry-velvet);
            font-family: 'Orbitron', sans-serif;
            overflow: hidden; color: white;
        }

        #game-table {
            position: relative; width: 100%; height: 100vh;
            display: flex; flex-direction: column; justify-content: space-between;
            align-items: center; padding: 40px 10px;
        }

        /* Зоны рук */
        .hand {
            display: flex; justify-content: center; width: 100%;
            height: var(--card-h); min-height: var(--card-h);
            perspective: 1000px;
        }

        #enemy-hand { transform: translateY(-10px); }
        #player-hand { transform: translateY(10px); z-index: 100; }

        /* Игровое поле */
        #battle-ground {
            flex-grow: 1; width: 100%; max-width: 400px;
            display: grid; grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(2, 1fr); gap: 10px;
            align-content: center; justify-items: center;
        }

        /* КАРТА */
        .card {
            width: var(--card-w); height: var(--card-h);
            background: #fff; border-radius: 8px; border: 1.5px solid var(--gold);
            box-shadow: 0 5px 15px rgba(0,0,0,0.5); position: relative;
            cursor: pointer; transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex; flex-direction: column; justify-content: space-between;
            padding: 5px; user-select: none; color: #000;
        }

        .card.back {
            background: #fff url('1771489965074(1).png') no-repeat center;
            background-size: 80%; border: 2px solid var(--gold);
        }

        .card.in-hand:hover { transform: translateY(-15px) scale(1.05); z-index: 10; }
        
        .card .suit-top { align-self: flex-start; font-size: 14px; font-weight: 900; }
        .card .val { align-self: center; font-size: 22px; font-weight: 900; }
        .card .suit-bot { align-self: flex-end; font-size: 14px; font-weight: 900; }
        .red { color: #d00; }

        /* Колода и Козырь */
        #deck-area {
            position: absolute; right: 15px; top: 50%; transform: translateY(-50%);
            display: flex; align-items: center;
        }

        .trump-view {
            transform: rotate(90deg) translateX(30px); position: absolute; z-index: 1;
        }

        .deck-stack { z-index: 5; box-shadow: -5px 0 10px #000; }

        /* Кнопки */
        .ui-panel { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); display: flex; flex-direction: column; gap: 15px; }
        .btn-vchf {
            background: var(--gold); border: none; padding: 12px; border-radius: 8px;
            font-family: 'Orbitron'; font-weight: 900; font-size: 10px; cursor: pointer;
            box-shadow: var(--gold-glow); transition: 0.2s;
        }
        .btn-vchf:active { transform: scale(0.9); }
        
        #status-msg { position: absolute; top: 15px; width: 100%; text-align: center; font-size: 10px; color: var(--gold); letter-spacing: 2px; }
    </style>
</head>
<body>

<div id="game-table">
    <div id="status-msg">INITIALIZING DURAK ENGINE...</div>
    
    <div id="enemy-hand" class="hand"></div>
    
    <div id="battle-ground"></div>

    <div id="deck-area">
        <div id="trump-slot"></div>
        <div id="main-deck" class="card back deck-stack"></div>
    </div>

    <div class="ui-panel">
        <button id="action-btn" class="btn-vchf" onclick="handleMainAction()">В ОЖИДАНИИ</button>
    </div>

    <div id="player-hand" class="hand"></div>
</div>

<script>
    /** * МАНИФЕСТ МОНОЛИТА: DURAK ELITE V 1.2
     * Автор: Искра (Spark) для Wanderer
     * Логика: Новый код = Старый + ИИ Атака/Защита
     */
    const tg = window.Telegram.WebApp;
    tg.expand();

    const suits = ['♠', '♣', '♥', '♦'];
    const values = ['6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];
    const valPower = {'6':6, '7':7, '8':8, '9':9, '10':10, 'J':11, 'Q':12, 'K':13, 'A':14};
    
    let deck = [], playerHand = [], enemyHand = [], table = [], trump = null;
    let isPlayerAttacking = true; 

    function initGame() {
        deck = [];
        suits.forEach(s => values.forEach(v => {
            deck.push({ suit: s, value: v, isRed: (s === '♥' || s === '♦') });
        }));
        shuffle(deck);
        trump = deck[0]; // Козырь — нижняя карта
        
        // Первая раздача
        deal();
        renderAll();
        updateStatus("ТВОЙ ХОД");
        updateBtn();
    }

    function shuffle(arr) {
        for (let i = arr.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [arr[i], arr[arr[j]]] = [arr[j], arr[i]];
        }
    }

    function deal() {
        while (playerHand.length < 6 && deck.length > 0) playerHand.push(deck.pop());
        while (enemyHand.length < 6 && deck.length > 0) enemyHand.push(deck.pop());
    }

    function createCardUI(card, hidden = false, onClick = null) {
        const div = document.createElement('div');
        div.className = 'card' + (hidden ? ' back' : ' in-hand');
        if (!hidden) {
            const cl = card.isRed ? 'red' : '';
            div.innerHTML = `<div class="suit-top ${cl}">${card.suit}</div><div class="val ${cl}">${card.value}</div><div class="suit-bot ${cl}">${card.suit}</div>`;
            if (onClick) div.onclick = onClick;
        }
        return div;
    }

    function renderAll() {
        // Отрисовка козыря
        const tSlot = document.getElementById('trump-slot');
        tSlot.innerHTML = '';
        const tCard = createCardUI(trump);
        tCard.classList.add('trump-view');
        tSlot.appendChild(tCard);

        // Рука игрока
        const pHand = document.getElementById('player-hand');
        pHand.innerHTML = '';
        playerHand.sort((a,b) => valPower[a.value] - valPower[b.value]).forEach((c, i) => {
            pHand.appendChild(createCardUI(c, false, () => playCard(i)));
        });

        // Рука врага (рубашки)
        const eHand = document.getElementById('enemy-hand');
        eHand.innerHTML = '';
        enemyHand.forEach(() => eHand.appendChild(createCardUI(null, true)));

        // Поле боя
        const bg = document.getElementById('battle-ground');
        bg.innerHTML = '';
        table.forEach(pair => {
            const wrap = document.createElement('div');
            wrap.style.position = 'relative';
            wrap.appendChild(createCardUI(pair.attack));
            if (pair.defense) {
                const def = createCardUI(pair.defense);
                def.style.position = 'absolute'; def.style.top = '15px'; def.style.left = '15px';
                wrap.appendChild(def);
            }
            bg.appendChild(wrap);
        });

        document.getElementById('main-deck').style.opacity = deck.length > 0 ? '1' : '0';
    }

    function playCard(idx) {
        const card = playerHand[idx];
        if (isPlayerAttacking) {
            // Атака
            if (table.length >= 6) return;
            if (table.length > 0) {
                const onTable = table.flatMap(p => [p.attack.value, p.defense?.value]).filter(Boolean);
                if (!onTable.includes(card.value)) return;
            }
            table.push({ attack: card, defense: null });
            playerHand.splice(idx, 1);
            tg.HapticFeedback.impactOccurred('medium');
            renderAll();
            setTimeout(enemyLogic, 600);
        } else {
            // Защита игрока
            const openIdx = table.findIndex(p => !p.defense);
            if (openIdx !== -1 && canBeat(card, table[openIdx].attack)) {
                table[openIdx].defense = card;
                playerHand.splice(idx, 1);
                tg.HapticFeedback.impactOccurred('light');
                renderAll();
                setTimeout(enemyLogic, 600);
            }
        }
        updateBtn();
    }

    function canBeat(card, toBeat) {
        if (card.suit === toBeat.suit) return valPower[card.value] > valPower[toBeat.value];
        if (card.suit === trump.suit && toBeat.suit !== trump.suit) return true;
        return false;
    }

    function enemyLogic() {
        if (isPlayerAttacking) {
            // Враг защищается
            const pair = table.find(p => !p.defense);
            if (!pair) return;
            const cardIdx = enemyHand.findIndex(c => canBeat(c, pair.attack));
            if (cardIdx !== -1) {
                pair.defense = enemyHand[cardIdx];
                enemyHand.splice(cardIdx, 1);
                updateStatus("ВРАГ ОТБИЛСЯ");
            } else {
                updateStatus("ВРАГ БЕРЁТ");
            }
        } else {
            // Враг нападает
            if (table.length === 0) {
                table.push({ attack: enemyHand.pop(), defense: null });
            } else {
                const onTable = table.flatMap(p => [p.attack.value, p.defense?.value]).filter(Boolean);
                const nextIdx = enemyHand.findIndex(c => onTable.includes(c.value));
                if (nextIdx !== -1 && table.length < 6) {
                    table.push({ attack: enemyHand.splice(nextIdx,1)[0], defense: null });
                } else {
                    updateStatus("ВРАГ: БИТО");
                }
            }
        }
        renderAll();
        updateBtn();
    }

    function handleMainAction() {
        const btn = document.getElementById('action-btn');
        if (btn.innerText === "БИТО") {
            table = []; deal(); isPlayerAttacking = false;
            updateStatus("ВРАГ ХОДИТ...");
            setTimeout(enemyLogic, 800);
        } else if (btn.innerText === "ВЗЯТЬ") {
            enemyHand.push(...table.flatMap(p => [p.attack, p.defense]).filter(Boolean));
            table = []; deal(); isPlayerAttacking = true;
            updateStatus("ТВОЙ ХОД");
        } else if (btn.innerText === "Я БЕРУ") {
            playerHand.push(...table.flatMap(p => [p.attack, p.defense]).filter(Boolean));
            table = []; deal(); isPlayerAttacking = false;
            setTimeout(enemyLogic, 800);
        }
        renderAll();
        updateBtn();
    }

    function updateBtn() {
        const btn = document.getElementById('action-btn');
        if (isPlayerAttacking) {
            const allDefended = table.length > 0 && table.every(p => p.defense);
            btn.innerText = allDefended ? "БИТО" : (table.length > 0 ? "ЖДЁМ..." : "ХОДИ!");
            btn.disabled = !allDefended && table.length > 0;
        } else {
            const hasAttack = table.some(p => !p.defense);
            btn.innerText = hasAttack ? "Я БЕРУ" : "БИТО";
        }
    }

    function updateStatus(m) { document.getElementById('status-msg').innerText = m; }

    window.onload = initGame;
</script>
</body>
</html>
