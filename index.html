<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lotto 2026 | Bi-Turbo Monolith</title>
    <style>
        :root {
            --vchf-gold: #d4af37;
            --vchf-gold-bright: #fff5a0;
            --vchf-red: #ff0033;
            --vchf-bg: #050505;
            --vchf-glass: rgba(0, 0, 0, 0.85);
            --ritual-gradient: radial-gradient(circle at center, #3a0008 0%, #000 100%);
            --shadow-glow: 0 0 20px rgba(212, 175, 55, 0.4);
        }

        * {
            margin: 0; padding: 0; box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            user-select: none; -webkit-user-drag: none;
        }

        body, html {
            width: 100%; height: 100%;
            background-color: var(--vchf-bg);
            font-family: 'Orbitron', 'Segoe UI', sans-serif;
            overflow: hidden; color: var(--vchf-gold);
        }

        /* ФОНОВОЙ ХАОС */
        #ritual-canvas {
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 1; pointer-events: none;
        }

        /* ВРАТА VCHF */
        #vchf-gate {
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            background: #000; z-index: 9999;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            transition: opacity 1.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .gate-logo {
            text-align: center; margin-bottom: 50px;
            filter: drop-shadow(var(--shadow-glow));
        }

        .gate-logo h1 {
            font-size: 64px; letter-spacing: 25px;
            background: linear-gradient(to bottom, var(--vchf-gold-bright), var(--vchf-gold));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }

        .ready-trigger {
            padding: 20px 60px; font-size: 24px; font-weight: 900;
            background: transparent; border: 2px solid var(--vchf-gold);
            color: var(--vchf-gold); border-radius: 50px;
            cursor: pointer; text-transform: uppercase;
            letter-spacing: 10px; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: var(--shadow-glow);
        }

        .ready-trigger:hover {
            background: var(--vchf-gold); color: #000;
            transform: scale(1.05); box-shadow: 0 0 40px var(--vchf-gold);
        }

        /* ИГРОВАЯ АРЕНА */
        #game-arena {
            width: 100vw; height: 100vh;
            background: var(--ritual-gradient);
            position: relative; display: none; z-index: 5;
        }

        /* СТАТУС-БАР */
        #status-bar {
            position: absolute; top: 15px; left: 15px;
            font-size: 11px; letter-spacing: 2px;
            color: #00ffaa; text-shadow: 0 0 8px rgba(0, 255, 170, 0.6);
            z-index: 100; font-family: monospace;
        }

        /* КОЗЫРЬ (ТОТЕН) */
        #totem-ghost {
            position: absolute; top: 20px; right: 20px;
            width: 70px; height: 70px;
            display: flex; justify-content: center; align-items: center;
            font-size: 45px; z-index: 500;
            border-radius: 50%; border: 1px solid rgba(212, 175, 55, 0.3);
            background: rgba(0,0,0,0.4); backdrop-filter: blur(5px);
            transition: all 1s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            transform: scale(0) rotate(-180deg);
        }

        #totem-ghost.active { transform: scale(1) rotate(0deg); box-shadow: var(--shadow-glow); }

        /* КРУГ СУДЬБЫ (36 СФЕР) */
        #destiny-circle {
            position: absolute; top: 35%; left: 50%;
            transform: translate(-50%, -50%);
            width: 1px; height: 1px; z-index: 200;
        }

        .ritual-sphere {
            position: absolute; width: 50px; height: 50px;
            background: url('1771489965074(1).png') center/cover;
            border-radius: 50%; border: 1.5px solid var(--vchf-gold);
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.5);
            cursor: pointer; transition: all 0.7s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 250;
        }

        .ritual-sphere:hover { transform: scale(1.2); filter: brightness(1.3); }

        @keyframes sphere-burst {
            0% { transform: scale(1); filter: brightness(1); }
            50% { transform: scale(2.5); filter: brightness(5) blur(4px); opacity: 0.5; }
            100% { transform: scale(0.1); opacity: 0; }
        }
        .bursting { animation: sphere-burst 0.6s forwards; pointer-events: none; }

        /* БУТОН ИГРОКА (РЯДЫ МАСТЕЙ) */
        #player-bud {
            position: absolute; bottom: 0; width: 100%;
            height: 42%; background: var(--vchf-glass);
            border-top: 2px solid rgba(212, 175, 55, 0.3);
            backdrop-filter: blur(15px); display: flex;
            flex-direction: column; padding: 10px 5px; z-index: 300;
        }

        .suit-row {
            flex: 1; display: flex; align-items: center;
            gap: 5px; padding: 2px 10px; overflow-x: auto;
            border-bottom: 1px solid rgba(212, 175, 55, 0.05);
            scrollbar-width: none;
        }
        .suit-row::-webkit-scrollbar { display: none; }

        /* КАРТЫ VCHF */
        .vchf-card {
            min-width: 60px; aspect-ratio: 2 / 3;
            background: #fff; border-radius: 8px;
            position: relative; display: flex; flex-direction: column;
            justify-content: space-between; padding: 5px;
            box-shadow: 4px 4px 12px rgba(0,0,0,0.6);
            transition: all 0.4s cubic-bezier(0.23, 1, 0.32, 1);
            cursor: pointer; border: 1px solid #ddd;
            transform-origin: center;
        }

        .vchf-card.red { color: var(--vchf-red); }
        .vchf-card.black { color: #111; }
        .vchf-card.is-trump { border: 2.5px solid var(--vchf-gold); box-shadow: 0 0 15px var(--vchf-gold); }

        .card-rank { font-size: 16px; font-weight: 900; line-height: 1; text-align: left; }
        .card-suit-main { font-size: 28px; align-self: center; line-height: 1; }
        .card-rank-rev { font-size: 16px; font-weight: 900; transform: rotate(180deg); text-align: left; }

        /* ПОЛЕ БОЯ */
        #battle-field {
            position: absolute; top: 20%; bottom: 45%;
            width: 100%; display: flex; justify-content: center;
            align-items: center; flex-wrap: wrap; gap: 15px;
            padding: 20px; z-index: 150;
        }

        /* ТЕНЬ ПРОТИВНИКА */
        #enemy-shadow {
            position: absolute; top: 0; width: 100%;
            height: 18%; display: flex; justify-content: center;
            align-items: flex-start; padding-top: 15px; z-index: 100;
        }

        .enemy-card-back {
            width: 40px; aspect-ratio: 2/3;
            background: linear-gradient(135deg, #222 0%, #000 100%);
            border: 1px solid rgba(212, 175, 55, 0.4);
            border-radius: 4px; margin-left: -25px;
            box-shadow: -3px 0 10px rgba(0,0,0,0.7);
            transition: transform 0.3s;
        }
        .enemy-card-back:first-child { margin-left: 0; }

        /* КНОПКИ ДЕЙСТВИЙ */
        #action-hub {
            position: absolute; top: -60px; right: 20px;
            display: flex; gap: 15px; z-index: 400;
        }

        .vchf-btn {
            padding: 12px 25px; background: #000;
            border: 1.5px solid var(--vchf-gold); color: var(--vchf-gold);
            font-size: 13px; font-weight: 900; border-radius: 6px;
            text-transform: uppercase; letter-spacing: 3px;
            cursor: pointer; box-shadow: var(--shadow-glow);
            transition: all 0.3s;
        }

        .vchf-btn:disabled { opacity: 0.3; cursor: not-allowed; border-color: #444; color: #444; box-shadow: none; }
        .vchf-btn:active { transform: translateY(3px); }

        #end-screen {
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.98); z-index: 10000;
            display: none; flex-direction: column;
            justify-content: center; align-items: center; text-align: center;
        }
    </style>
</head>
<body>
    <canvas id="ritual-canvas"></canvas>

    <div id="vchf-gate">
        <div class="gate-logo">
            <h1>VCHF</h1>
            <p style="letter-spacing: 5px; opacity: 0.7; font-size: 12px;">ULTIMATE MONOLITH 2026</p>
        </div>
        <button class="ready-trigger" onclick="vchf_ritual_start()">ГОТОВ</button>
    </div>

    <div id="game-arena">
        <div id="status-bar">SYSTEM: STANDBY...</div>
        <div id="totem-ghost"></div>
        <div id="destiny-circle"></div>

        <div id="enemy-shadow"></div>

        <div id="battle-field"></div>

        <div id="player-bud">
            <div id="action-hub">
                <button class="vchf-btn" id="btn-take" onclick="vchf_take()">ВЗЯТЬ</button>
                <button class="vchf-btn" id="btn-bito" onclick="vchf_bito()" disabled>БИТО</button>
            </div>
            <div class="suit-row" id="row-hearts"></div>
            <div class="suit-row" id="row-diamonds"></div>
            <div class="suit-row" id="row-clubs"></div>
            <div class="suit-row" id="row-spades"></div>
        </div>
    </div>

    <div id="end-screen"></div>

    <script>
        /* ЯКОРЯ МОНОЛИТА:
           vchf_state - глобальное состояние
           vchf_ritual_start - запуск
           vchf_move - логика хода
        */
        const SUITS = ['♥', '♦', '♣', '♠'];
        const RANKS = ['6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];
        const RANK_VAL = { '6':6, '7':7, '8':8, '9':9, '10':10, 'J':11, 'Q':12, 'K':13, 'A':14 };

        let vchf_state = {
            active: false,
            phase: 'gathering', // gathering -> battle -> end
            deck: [],
            pHand: [],
            eHand: [],
            table: [],
            trump: null,
            turn: 'player',
            ai_memory: [],
            balance: 1000,
            commission: 0.01
        };

        function vchf_log(msg) {
            document.getElementById('status-bar').innerText = `SYSTEM: ${msg}`;
        }
        function vchf_ritual_start() {
            document.getElementById('vchf-gate').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('vchf-gate').style.display = 'none';
                document.getElementById('game-arena').style.display = 'block';
                vchf_init_deck();
                vchf_spawn_destiny_circle();
                vchf_start_bg_particles();
                vchf_log("РИТУАЛ АКТИВИРОВАН. ВЫБЕРИТЕ СФЕРУ.");
            }, 1200);
        }

        function vchf_init_deck() {
            vchf_state.deck = [];
            let id = 1;
            SUITS.forEach(suit => {
                RANKS.forEach(rank => {
                    vchf_state.deck.push({
                        id: id++,
                        suit: suit,
                        rank: rank,
                        val: RANK_VAL[rank],
                        color: (suit === '♥' || suit === '♦') ? 'red' : 'black'
                    });
                });
            });
            // Тасовка по алгоритму Фишера-Йетса
            for (let i = vchf_state.deck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [vchf_state.deck[i], vchf_state.deck[j]] = [vchf_state.deck[j], vchf_state.deck[i]];
            }
        }

        function vchf_spawn_destiny_circle() {
            const circle = document.getElementById('destiny-circle');
            circle.innerHTML = '';
            // Радиус круга в зависимости от экрана
            const radius = Math.min(window.innerWidth, window.innerHeight) * 0.38;
            
            vchf_state.deck.forEach((card, i) => {
                const sphere = document.createElement('div');
                sphere.className = 'ritual-sphere';
                sphere.id = `sphere-${card.id}`;
                
                // Равномерное распределение 36 сфер по кругу
                const angle = (i / vchf_state.deck.length) * Math.PI * 2;
                const x = Math.cos(angle) * radius;
                const y = Math.sin(angle) * radius;
                
                sphere.style.left = `${x}px`;
                sphere.style.top = `${y}px`;
                
                sphere.onclick = () => vchf_capture_card(card.id);
                circle.appendChild(sphere);
            });
        }

        function vchf_capture_card(cardId) {
            if (vchf_state.phase !== 'gathering') return;
            
            const cardIdx = vchf_state.deck.findIndex(c => c.id === cardId);
            if (cardIdx === -1) return;
            
            const card = vchf_state.deck.splice(cardIdx, 1)[0];
            vchf_process_capture(card, 'player');
            
            // Ответный ход ИИ (мгновенный захват своей сферы)
            if (vchf_state.deck.length > 0) {
                setTimeout(() => {
                    const aiIdx = Math.floor(Math.random() * vchf_state.deck.length);
                    const aiCard = vchf_state.deck.splice(aiIdx, 1)[0];
                    vchf_process_capture(aiCard, 'enemy');
                    
                    if (vchf_state.deck.length === 0) vchf_finalize_gathering();
                }, 200);
            } else {
                vchf_finalize_gathering();
            }
        }

        function vchf_process_capture(card, owner) {
            const sphere = document.getElementById(`sphere-${card.id}`);
            if (sphere) {
                sphere.classList.add('bursting');
                // Визуальный полет в сторону игрока или врага
                const targetY = (owner === 'player') ? window.innerHeight : -window.innerHeight;
                sphere.style.transform = `translateY(${targetY}px) scale(0.2)`;
                setTimeout(() => sphere.remove(), 600);
            }

            if (owner === 'player') {
                vchf_state.pHand.push(card);
                vchf_render_hand();
            } else {
                vchf_state.eHand.push(card);
                vchf_render_enemy();
            }
        }

        function vchf_render_hand() {
            // Очистка всех рядов мастей
            ['hearts', 'diamonds', 'clubs', 'spades'].forEach(id => {
                document.getElementById(`row-${id}`).innerHTML = '';
            });

            // Сортировка по мастям и рангу (Smart-фильтр)
            vchf_state.pHand.sort((a, b) => a.val - b.val).forEach(card => {
                let rowId = '';
                switch(card.suit) {
                    case '♥': rowId = 'row-hearts'; break;
                    case '♦': rowId = 'row-diamonds'; break;
                    case '♣': rowId = 'row-clubs'; break;
                    case '♠': rowId = 'row-spades'; break;
                }
                
                const cardEl = document.createElement('div');
                cardEl.className = `vchf-card ${card.color} ${card.suit === vchf_state.trump ? 'is-trump' : ''}`;
                cardEl.innerHTML = `
                    <div class="card-rank">${card.rank}</div>
                    <div class="card-suit-main">${card.suit}</div>
                    <div class="card-rank-rev">${card.rank}</div>
                `;
                cardEl.onclick = () => vchf_player_move(card);
                document.getElementById(rowId).appendChild(cardEl);
            });
        }

        function vchf_render_enemy() {
            const shadow = document.getElementById('enemy-shadow');
            shadow.innerHTML = '';
            vchf_state.eHand.forEach(() => {
                const back = document.createElement('div');
                back.className = 'enemy-card-back';
                shadow.appendChild(back);
            });
        }

        function vchf_finalize_gathering() {
            vchf_state.phase = 'battle';
            // Последняя карта в колоде определяет козырь (если бы колода оставалась)
            // Но у нас 36 сфер разлетаются полностью. Назначим козырь из случайной масти.
            vchf_state.trump = SUITS[Math.floor(Math.random() * SUITS.length)];
            
            const totem = document.getElementById('totem-ghost');
            totem.innerHTML = vchf_state.trump;
            totem.className = 'active';
            totem.style.color = (vchf_state.trump === '♥' || vchf_state.trump === '♦') ? 'var(--vchf-red)' : '#fff';
            
            vchf_log(`КОЗЫРЬ: ${vchf_state.trump}. ВАШ ХОД.`);
            vchf_render_hand(); // Перерисовываем с учетом козыря
        }
        function vchf_player_move(card) {
            if (vchf_state.phase !== 'battle' || vchf_state.turn !== 'player') return;
            
            // Проверка: можно ли подкинуть эту карту
            if (vchf_state.table.length > 0) {
                const canAdd = vchf_state.table.some(c => c.rank === card.rank);
                if (!canAdd) {
                    vchf_log("ЭТОЙ КАРТЫ НЕТ НА СТОЛЕ!");
                    return;
                }
            }

            // Перенос карты из руки на стол
            const idx = vchf_state.pHand.indexOf(card);
            vchf_state.pHand.splice(idx, 1);
            vchf_state.table.push(card);
            
            vchf_render_battlefield();
            vchf_render_hand();
            
            vchf_log(`ВЫ ПОШЛИ: ${card.rank}${card.suit}`);
            
            // Передаем ход ИИ для защиты
            setTimeout(() => vchf_ai_defend(card), 800);
        }

        function vchf_render_battlefield() {
            const field = document.getElementById('battle-field');
            field.innerHTML = '';
            
            vchf_state.table.forEach((card, i) => {
                const cardEl = document.createElement('div');
                cardEl.className = `vchf-card ${card.color} ${card.suit === vchf_state.trump ? 'is-trump' : ''}`;
                cardEl.style.position = (i % 2 !== 0) ? 'absolute' : 'relative';
                // Смещение для кроющей карты
                if (i % 2 !== 0) {
                    cardEl.style.transform = 'translate(15px, 15px) rotate(5deg)';
                    cardEl.style.zIndex = i + 10;
                }
                
                cardEl.innerHTML = `
                    <div class="card-rank">${card.rank}</div>
                    <div class="card-suit-main">${card.suit}</div>
                    <div class="card-rank-rev">${card.rank}</div>
                `;
                field.appendChild(cardEl);
            });

            // Управление кнопками
            const btnBito = document.getElementById('btn-bito');
            const btnTake = document.getElementById('btn-take');
            
            if (vchf_state.turn === 'player' && vchf_state.table.length > 0 && vchf_state.table.length % 2 === 0) {
                btnBito.disabled = false;
            } else {
                btnBito.disabled = true;
            }
        }

        function vchf_bito() {
            vchf_log("БИТО. ХОД ПЕРЕХОДИТ К ВАМ.");
            vchf_state.table = [];
            vchf_render_battlefield();
            vchf_state.turn = 'player'; // После БИТО ход атакующего сохраняется или меняется (здесь - сохраняем инициативу)
            vchf_check_win();
        }

        function vchf_take() {
            if (vchf_state.turn === 'enemy') {
                vchf_log("ВЫ ЗАБРАЛИ КАРТЫ.");
                vchf_state.pHand.push(...vchf_state.table);
                vchf_state.table = [];
                vchf_render_hand();
                vchf_render_battlefield();
                vchf_state.turn = 'enemy'; // Ход остается у ИИ
                setTimeout(vchf_ai_attack, 1000);
            }
        }

        function vchf_check_win() {
            if (vchf_state.pHand.length === 0 && vchf_state.deck.length === 0) {
                vchf_finalize_game("ВЫ ПОБЕДИЛИ! ЗОЛОТО VCHF ВАШЕ.");
            } else if (vchf_state.eHand.length === 0 && vchf_state.deck.length === 0) {
                vchf_finalize_game("ТЕНЬ ПОБЕДИЛА. ПОПРОБУЙТЕ СНОВА.");
            }
        }
        function vchf_ai_defend(attackCard) {
            vchf_state.turn = 'enemy';
            vchf_log("ИИ ДУМАЕТ...");

            // Логика выбора карты для защиты
            // 1. Ищем карту той же масти, но выше рангом
            // 2. Если нет, ищем козырь (если атака не козырная)
            let defenseCard = vchf_state.eHand
                .filter(c => (c.suit === attackCard.suit && c.val > attackCard.val) || 
                             (vchf_state.trump === c.suit && attackCard.suit !== vchf_state.trump))
                .sort((a, b) => {
                    // Приоритет: сначала кроемся не козырями, и самыми маленькими из возможных
                    if (a.suit === vchf_state.trump && b.suit !== vchf_state.trump) return 1;
                    if (a.suit !== vchf_state.trump && b.suit === vchf_state.trump) return -1;
                    return a.val - b.val;
                })[0];

            if (defenseCard) {
                setTimeout(() => {
                    const idx = vchf_state.eHand.indexOf(defenseCard);
                    vchf_state.eHand.splice(idx, 1);
                    vchf_state.table.push(defenseCard);
                    vchf_render_battlefield();
                    vchf_render_enemy();
                    vchf_log(`ИИ ПОКРЫЛ: ${defenseCard.rank}${defenseCard.suit}`);
                    vchf_state.turn = 'player'; // Ждем, подкинет ли игрок еще
                }, 1000);
            } else {
                // ИИ нечем крыться - он забирает всё со стола
                setTimeout(() => {
                    vchf_log("ИИ ЗАБИРАЕТ КАРТЫ.");
                    vchf_state.eHand.push(...vchf_state.table);
                    vchf_state.table = [];
                    vchf_render_enemy();
                    vchf_render_battlefield();
                    vchf_state.turn = 'player'; // Ход остается у игрока
                    vchf_check_win();
                }, 1000);
            }
        }

        function vchf_ai_attack() {
            if (vchf_state.phase !== 'battle' || vchf_state.eHand.length === 0) return;
            vchf_state.turn = 'enemy';

            let attackCard;
            if (vchf_state.table.length === 0) {
                // Первый ход ИИ: выбирает самую слабую не козырную карту
                attackCard = vchf_state.eHand
                    .sort((a, b) => {
                        if (a.suit === vchf_state.trump && b.suit !== vchf_state.trump) return 1;
                        if (a.suit !== vchf_state.trump && b.suit === vchf_state.trump) return -1;
                        return a.val - b.val;
                    })[0];
            } else {
                // Подкидывание: ищет карту того же ранга, что уже на столе
                attackCard = vchf_state.eHand.find(ec => 
                    vchf_state.table.some(tc => tc.rank === ec.rank)
                );
            }

            if (attackCard && vchf_state.table.length < 12) { // Лимит карт на столе
                setTimeout(() => {
                    const idx = vchf_state.eHand.indexOf(attackCard);
                    vchf_state.eHand.splice(idx, 1);
                    vchf_state.table.push(attackCard);
                    vchf_render_battlefield();
                    vchf_render_enemy();
                    vchf_log(`ИИ АТАКУЕТ: ${attackCard.rank}${attackCard.suit}`);
                    // Теперь игрок должен крыться или взять
                    // Кнопки управления игрока активируются логикой рендеринга
                }, 1000);
            } else {
                // ИИ больше нечего подкинуть - БИТО
                vchf_log("ИИ ГОВОРИТ: БИТО.");
                vchf_state.table = [];
                vchf_render_battlefield();
                vchf_state.turn = 'player';
                vchf_check_win();
            }
        }

        // Автоматический запуск атаки ИИ, если его ход
        setInterval(() => {
            if (vchf_state.phase === 'battle' && vchf_state.turn === 'enemy' && vchf_state.table.length % 2 === 0) {
                if (!is_ai_thinking) {
                    is_ai_thinking = true;
                    vchf_ai_attack();
                    setTimeout(() => { is_ai_thinking = false; }, 1500);
                }
            }
        }, 2000);

        let is_ai_thinking = false;
        /* ВИЗУАЛЬНЫЙ ДВИЖОК VCHF (PARTICLES) */
        const vchf_canvas = document.getElementById('ritual-canvas');
        const vchf_ctx = vchf_canvas.getContext('2d');
        let vchf_particles = [];

        function vchf_start_bg_particles() {
            vchf_resize_canvas();
            window.addEventListener('resize', vchf_resize_canvas);
            vchf_create_particles();
            vchf_animate_particles();
        }

        function vchf_resize_canvas() {
            vchf_canvas.width = window.innerWidth;
            vchf_canvas.height = window.innerHeight;
        }

        function vchf_create_particles() {
            vchf_particles = [];
            const count = 50; // Оптимально для Bi-Turbo
            for (let i = 0; i < count; i++) {
                vchf_particles.push({
                    x: Math.random() * vchf_canvas.width,
                    y: Math.random() * vchf_canvas.height,
                    size: Math.random() * 2 + 1,
                    speedY: Math.random() * 0.4 + 0.1,
                    opacity: Math.random() * 0.5 + 0.1,
                    drift: Math.random() * 0.5 - 0.25
                });
            }
        }

        function vchf_animate_particles() {
            vchf_ctx.clearRect(0, 0, vchf_canvas.width, vchf_canvas.height);
            vchf_ctx.fillStyle = '#d4af37'; // Золото VCHF

            vchf_particles.forEach(p => {
                p.y -= p.speedY;
                p.x += p.drift;
                
                if (p.y < -10) {
                    p.y = vchf_canvas.height + 10;
                    p.x = Math.random() * vchf_canvas.width;
                }
                if (p.x < 0 || p.x > vchf_canvas.width) p.drift *= -1;

                vchf_ctx.globalAlpha = p.opacity;
                vchf_ctx.beginPath();
                vchf_ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                vchf_ctx.fill();
            });
            requestAnimationFrame(vchf_animate_particles);
        }

        /* ЛОГИКА ТРАНЗАКЦИЙ (VCHF BALANCE) */
        function vchf_apply_commission(amount) {
            const fee = amount * vchf_state.commission;
            vchf_state.balance -= (amount + fee);
            vchf_log(`ТРАНЗАКЦИЯ: -${amount} VCHF (КОМ: ${fee.toFixed(2)})`);
        }

        /* ЭФФЕКТ "ЗЕРКАЛЬНЫЙ РАУНД" */
        function vchf_trigger_flash() {
            const arena = document.getElementById('game-arena');
            arena.style.filter = 'brightness(3) saturate(0)';
            setTimeout(() => {
                arena.style.transition = 'filter 0.8s ease';
                arena.style.filter = 'brightness(1) saturate(1)';
            }, 100);
        }

        /* ФИНАЛИЗАЦИЯ ИГРЫ */
        function vchf_finalize_game(resultText) {
            vchf_state.phase = 'end';
            const screen = document.getElementById('end-screen');
            screen.style.display = 'flex';
            screen.innerHTML = `
                <h2 style="font-size: 40px; color: var(--vchf-gold); margin-bottom: 20px;">${resultText}</h2>
                <button class="ready-trigger" onclick="location.reload()">НОВЫЙ ЦИКЛ</button>
                <p style="margin-top: 30px; font-size: 10px; letter-spacing: 5px; opacity: 0.5;">MONOLITH CORE 1.0</p>
            `;
            vchf_trigger_flash();
        }
        /* СИСТЕМА СТАБИЛИЗАЦИИ VCHF (АНТИ-КРАШ) */
        window.onerror = function(msg, url, line) {
            vchf_log(`ОШИБКА: ${msg} [L:${line}]`);
            console.error("VCHF CRITICAL:", msg, "at", line);
            return true; // Предотвращаем вылет игры
        };

        // Адаптивное управление при изменении размера экрана
        window.addEventListener('resize', () => {
            if (vchf_state.phase === 'gathering') {
                vchf_spawn_destiny_circle(); // Пересчитываем координаты 36 сфер
            }
            vchf_render_hand();
            vchf_render_battlefield();
        });

        /* ДОПОЛНИТЕЛЬНАЯ ЛОГИКА АНИМАЦИИ КАРТ (ПОЛЕТ В БУТОН) */
        function vchf_animate_card_flight(cardId, owner) {
            const cardEl = document.querySelector(`.vchf-card[data-id="${cardId}"]`);
            if (!cardEl) return;

            const target = (owner === 'player') ? 
                document.getElementById('player-bud').getBoundingClientRect() : 
                document.getElementById('enemy-shadow').getBoundingClientRect();

            cardEl.style.transition = 'all 0.8s cubic-bezier(0.6, -0.28, 0.735, 0.045)';
            cardEl.style.position = 'fixed';
            cardEl.style.left = `${target.left + target.width/2}px`;
            cardEl.style.top = `${target.top + target.height/2}px`;
            cardEl.style.transform = 'scale(0.1) rotate(360deg)';
            cardEl.style.opacity = '0';
        }

        /* КОНТРОЛЬ ТРАНЗАКЦИЙ (ПРОТОКОЛ 1.1) */
        function vchf_verify_monolith() {
            const integrity = (vchf_state.deck.length + vchf_state.pHand.length + vchf_state.eHand.length + vchf_state.table.length);
            if (integrity !== 36) {
                vchf_log("ВНИМАНИЕ: НАРУШЕНИЕ ЦЕЛОСТНОСТИ КОЛОДЫ!");
                console.warn("Monolith integrity check failed. Count:", integrity);
            }
        }

        // Запускаем проверку целостности каждые 10 секунд
        setInterval(vchf_verify_monolith, 10000);

        /* ИНИЦИАЛИЗАЦИЯ ПРИ ЗАГРУЗКЕ */
        window.onload = () => {
            vchf_log("СИСТЕМА ГОТОВА. ЖДЕМ РИТУАЛА.");
            // Манифест Монолита: Новый код = Старый код + Введенная функция
            console.log("Нулевой Хаос: Проект Лотто (Bi-Turbo Ultimate) Активен.");
        };

        /* КОНЕЦ СКРИПТА */
    </script>
</body>
</html>
