<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lotto VCHF | Monolith Edition</title>
    <style>
        :root {
            --vchf-gold: #d4af37;
            --vchf-gold-bright: #fff5a0;
            --vchf-red: #ff0033;
            --vchf-bg: #050505;
            --vchf-glass: rgba(0, 0, 0, 0.85);
            --card-ratio: 1.5; /* Соотношение 2:3 */
            --shadow-glow: 0 0 15px rgba(212, 175, 55, 0.3);
            --ritual-gradient: radial-gradient(circle at center, #3a0008 0%, #000 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        body, html {
            width: 100%;
            height: 100%;
            background-color: #000;
            font-family: 'Orbitron', sans-serif;
            overflow: hidden;
            color: var(--vchf-gold);
        }

        /* ХОЛСТ РИТУАЛА */
        #ritual-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            pointer-events: none;
        }

        /* ЭКРАН ВХОДА */
        #vchf-gate {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: opacity 0.8s ease;
        }

        .ready-trigger {
            padding: 15px 45px;
            font-size: 22px;
            font-weight: 900;
            background: transparent;
            border: 2px solid var(--vchf-gold);
            color: var(--vchf-gold);
            border-radius: 40px;
            cursor: pointer;
            box-shadow: var(--shadow-glow);
            text-transform: uppercase;
            letter-spacing: 8px;
            transition: all 0.3s;
        }

        .ready-trigger:active {
            transform: scale(0.95);
            background: var(--vchf-gold);
            color: #000;
        }

        /* ГЛАВНЫЙ СТОЛ */
        #game-arena {
            width: 100vw;
            height: 100vh;
            background: var(--ritual-gradient);
            position: relative;
            display: none; /* Проявится после нажатия Готов */
        }

        /* ИНФОРМАЦИОННЫЙ СЛОЙ */
        #status-bar {
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 10px;
            letter-spacing: 1px;
            color: #00ff00;
            z-index: 100;
            text-shadow: 0 0 5px #000;
        }

        /* ТОТЕН-ПРИЗРАК (ВЕРХНИЙ ПРАВЫЙ УГОЛ) */
        #totem-ghost {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 60px;
            height: 60px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 40px;
            z-index: 500;
            border-radius: 50%;
            transition: all 1.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .pulsing-aura {
            animation: vchf-pulse 2s infinite ease-in-out;
        }

        @keyframes vchf-pulse {
            0% { filter: drop-shadow(0 0 5px var(--vchf-gold)); opacity: 0.7; }
            50% { filter: drop-shadow(0 0 20px var(--vchf-gold)); opacity: 1; }
            100% { filter: drop-shadow(0 0 5px var(--vchf-gold)); opacity: 0.7; }
        }

        /* БАРАБАН СУДЬБЫ */
        #destiny-circle {
            position: absolute;
            top: 32%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 1px;
            height: 1px;
            z-index: 200;
        }
        /* Код продолжается в следующих окнах */
    </style>
</head>
<body>
    <canvas id="ritual-canvas"></canvas>

    <div id="vchf-gate">
        <div style="margin-bottom: 40px; text-align: center;">
            <h1 style="font-size: 48px; letter-spacing: 20px; color: var(--vchf-gold);">VCHF</h1>
            <p style="font-size: 10px; letter-spacing: 3px; opacity: 0.6;">ZERO CHAOS ENGINE 2026</p>
        </div>
        <button class="ready-trigger" onclick="initRitual()">ГОТОВ</button>
    </div>

    <div id="game-arena">
        <div id="status-bar">SYSTEM: STANDBY</div>
        <div id="totem-ghost"></div>
        <div id="destiny-circle"></div>
        
        <div id="enemy-shadow" style="position: absolute; top: 0; width: 100%; height: 15%; display: flex; justify-content: center; align-items: flex-start; padding-top: 10px;"></div>

        <div id="battle-field" style="position: absolute; top: 18%; bottom: 42%; width: 100%; display: flex; justify-content: center; align-items: center; flex-wrap: wrap; gap: 5px; padding: 10px;"></div>

        <div id="player-bud" style="position: absolute; bottom: 0; width: 100%; height: 40%; background: var(--vchf-glass); border-top: 1px solid rgba(212,175,55,0.3); backdrop-filter: blur(8px); display: flex; flex-direction: column; padding: 5px;">
            <div id="action-hub" style="position: absolute; top: -50px; right: 10px; display: flex; gap: 10px;">
                <button class="vchf-action-btn" id="btn-take" onclick="vchfTake()">ВЗЯТЬ</button>
                <button class="vchf-action-btn" id="btn-bito" onclick="vchfBito()" disabled>БИТО</button>
            </div>
            <div class="suit-row" id="row-hearts"></div>
            <div class="suit-row" id="row-diamonds"></div>
            <div class="suit-row" id="row-clubs"></div>
            <div class="suit-row" id="row-spades"></div>
        </div>
    </div>
    <style>
        /* --- WINDOW 2: CARD GEOMETRY & SUIT ROWS --- */

        .suit-row {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 2px;
            padding: 2px 5px;
            overflow-x: auto;
            scrollbar-width: none; /* Скрываем скролл */
            position: relative;
            border-bottom: 1px solid rgba(212, 175, 55, 0.1);
        }
        .suit-row::-webkit-scrollbar { display: none; }

        /* Золотая аура козырного ряда */
        .trump-aura-row {
            background: linear-gradient(90deg, rgba(212, 175, 55, 0.15) 0%, transparent 100%);
            box-shadow: inset 0 0 15px rgba(212, 175, 55, 0.1);
        }

        /* КАРТА: Вертикальная структура 2:3 */
        .vchf-card {
            min-width: 55px; /* Адаптивно под телефон */
            aspect-ratio: 2 / 3;
            background: #fff;
            border-radius: 6px;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 4px;
            box-shadow: 2px 2px 8px rgba(0,0,0,0.5);
            transition: transform 0.3s cubic-bezier(0.23, 1, 0.32, 1), box-shadow 0.3s;
            cursor: pointer;
            border: 1px solid #ccc;
        }

        .vchf-card.red { color: var(--vchf-red); }
        .vchf-card.black { color: #000; }

        /* Козырная рамка */
        .vchf-card.is-trump {
            border: 2px solid var(--vchf-gold);
            box-shadow: 0 0 10px var(--vchf-gold);
        }

        .card-rank { font-size: 14px; font-weight: 900; line-height: 1; }
        .card-suit-main { font-size: 24px; align-self: center; }
        .card-rank-rev { font-size: 14px; font-weight: 900; transform: rotate(180deg); }

        /* СФЕРА В БАРАБАНЕ (До взрыва) */
        .ritual-sphere {
            position: absolute;
            width: 45px;
            height: 45px;
            background: url('1771489965074(1).png') center/cover;
            border-radius: 50%;
            border: 1px solid var(--vchf-gold);
            box-shadow: 0 0 10px rgba(212, 175, 55, 0.5);
            transition: all 0.6s cubic-bezier(0.5, -0.5, 0.5, 1.5);
            z-index: 250;
        }

        /* АНИМАЦИЯ ВЗРЫВА (Превращение сферы в карту) */
        @keyframes sphere-burst {
            0% { transform: scale(1); filter: brightness(1); }
            50% { transform: scale(1.8); filter: brightness(3) blur(2px); opacity: 0.8; }
            100% { transform: scale(1); filter: brightness(1); opacity: 1; }
        }

        .bursting { animation: sphere-burst 0.5s forwards; }

        /* ТЕНЬ ПРОТИВНИКА (Рубашки карт) */
        .enemy-card-back {
            width: 35px;
            aspect-ratio: 2/3;
            background: linear-gradient(135deg, #1a1a1a 0%, #000 100%);
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 3px;
            margin-left: -20px; /* Эффект веера */
            box-shadow: -2px 0 5px rgba(0,0,0,0.5);
        }
        .enemy-card-back:first-child { margin-left: 0; }

        /* КНОПКИ ДЕЙСТВИЯ */
        .vchf-action-btn {
            padding: 8px 18px;
            background: #000;
            border: 1px solid var(--vchf-gold);
            color: var(--vchf-gold);
            font-size: 12px;
            font-weight: 900;
            border-radius: 4px;
            text-transform: uppercase;
            letter-spacing: 2px;
            transition: 0.2s;
        }
        .vchf-action-btn:disabled {
            opacity: 0.3;
            border-color: #555;
            color: #555;
        }

        /* ЭКРАН ФИНАЛА */
        #end-screen {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 10000;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }
    </style>
    <script>
        /* --- WINDOW 3: INITIALIZATION & DESTINY CIRCLE --- */

        const SUITS = ['♥', '♦', '♣', '♠'];
        const RANKS = ['6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];
        const RANK_VALUES = { '6': 6, '7': 7, '8': 8, '9': 9, '10': 10, 'J': 11, 'Q': 12, 'K': 13, 'A': 14 };

        let vchf_state = {
            active: false,
            phase: 'gathering', // gathering -> battle -> take_window
            deck: [],
            pHand: [], // Твой Бутон
            eHand: [], // Тень ИИ
            table: [],
            trump: null,
            oldTrump: null,
            isMirrorRound: false,
            turn: 'player', // Кто атакует
            aiMemory: [], // Число Миллера (макс 7)
            aiForgetRate: 0.1 // Шанс ошибки 10%
        };

        function initRitual() {
            document.getElementById('vchf-gate').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('vchf-gate').style.display = 'none';
                document.getElementById('game-arena').style.display = 'block';
                createDeck();
                spawnDestinyCircle();
                startRitualBG(); // Запуск холста из Window 9 (будет позже)
                logStatus("РИТУАЛ НАЧАТ: ВЫБЕРИ СВОЮ СУДЬБУ");
            }, 800);
        }

        function createDeck() {
            vchf_state.deck = [];
            let id = 0;
            SUITS.forEach(suit => {
                RANKS.forEach(rank => {
                    vchf_state.deck.push({
                        id: id++,
                        suit: suit,
                        rank: rank,
                        val: RANK_VALUES[rank],
                        color: (suit === '♥' || suit === '♦') ? 'red' : 'black'
                    });
                });
            });
            // Перемешивание Хаоса
            vchf_state.deck.sort(() => Math.random() - 0.5);
        }

        function spawnDestinyCircle() {
            const circle = document.getElementById('destiny-circle');
            const radius = Math.min(window.innerWidth, window.innerHeight) * 0.35;
            
            vchf_state.deck.forEach((card, i) => {
                const sphere = document.createElement('div');
                sphere.className = 'ritual-sphere';
                sphere.id = `sphere-${card.id}`;
                
                // Расчет координат по кругу
                const angle = (i / vchf_state.deck.length) * Math.PI * 2;
                const x = Math.cos(angle) * radius;
                const y = Math.sin(angle) * radius;
                
                sphere.style.left = `${x}px`;
                sphere.style.top = `${y}px`;
                
                // Задержка появления для эффекта "разворачивания"
                sphere.style.opacity = '0';
                sphere.style.transform = 'scale(0) rotate(180deg)';
                
                circle.appendChild(sphere);

                setTimeout(() => {
                    sphere.style.opacity = '1';
                    sphere.style.transform = 'scale(1) rotate(0deg)';
                }, i * 30);

                sphere.onclick = () => captureCard(card.id);
            });
        }

        function logStatus(msg) {
            const bar = document.getElementById('status-bar');
            bar.innerText = `SYSTEM: ${msg}`;
            console.log(`[VCHF LOG]: ${msg}`);
        }

        // Вспомогательная функция для получения масти из ID
        function getCardById(id) {
            return vchf_state.deck.find(c => c.id === id);
        }
    </script>
        /* --- WINDOW 4: CAPTURE MECHANIC & CARD TRANSFORMATION --- */

        let isAiThinking = false;

        function captureCard(cardId) {
            if (vchf_state.phase !== 'gathering' || isAiThinking) return;

            const card = vchf_state.deck.find(c => c.id === cardId);
            if (!card) return;

            // Ход игрока
            processCapture(card, 'player');
            
            // Если остались карты, ИИ делает выбор
            if (vchf_state.deck.length > 0) {
                isAiThinking = true;
                logStatus("ИИ СКАНИРУЕТ ВЕРОЯТНОСТИ...");
                setTimeout(aiCapture, 600);
            }
        }

        function aiCapture() {
            if (vchf_state.deck.length === 0) {
                finalizeRitual();
                return;
            }

            // ИИ выбирает случайную сферу (он не видит номиналы)
            const randomIndex = Math.floor(Math.random() * vchf_state.deck.length);
            const card = vchf_state.deck[randomIndex];
            
            processCapture(card, 'enemy');
            isAiThinking = false;
            
            if (vchf_state.deck.length === 0) finalizeRitual();
        }

        function processCapture(card, owner) {
            // Удаляем из колоды
            vchf_state.deck = vchf_state.deck.filter(c => c.id !== card.id);
            
            const sphere = document.getElementById(`sphere-${card.id}`);
            if (sphere) {
                sphere.classList.add('bursting');
                // Визуальный полет
                const targetRect = owner === 'player' ? 
                    document.getElementById('player-bud').getBoundingClientRect() :
                    document.getElementById('enemy-shadow').getBoundingClientRect();
                
                sphere.style.left = `${targetRect.left + targetRect.width/2}px`;
                sphere.style.top = `${targetRect.top}px`;
                sphere.style.opacity = '0';
            }

            if (owner === 'player') {
                vchf_state.pHand.push(card);
                setTimeout(() => renderPlayerBud(), 500);
            } else {
                vchf_state.eHand.push(card);
                setTimeout(() => renderEnemyShadow(), 500);
            }
            
            setTimeout(() => sphere?.remove(), 500);
        }

        function renderPlayerBud() {
            SUITS.forEach(suit => {
                const rowId = suit === '♥' ? 'row-hearts' : 
                              suit === '♦' ? 'row-diamonds' : 
                              suit === '♣' ? 'row-clubs' : 'row-spades';
                const row = document.getElementById(rowId);
                row.innerHTML = '';

                // Сортировка по рангу внутри ряда
                const sortedSuit = vchf_state.pHand
                    .filter(c => c.suit === suit)
                    .sort((a, b) => a.val - b.val);

                sortedSuit.forEach(card => {
                    const cardEl = document.createElement('div');
                    cardEl.className = `vchf-card ${card.color}`;
                    cardEl.innerHTML = `
                        <div class="card-rank">${card.rank}</div>
                        <div class="card-suit-main">${card.suit}</div>
                        <div class="card-rank-rev">${card.rank}</div>
                    `;
                    cardEl.onclick = () => handleCardPlay(card);
                    row.appendChild(cardEl);
                });
            });
        }

        function renderEnemyShadow() {
            const shadow = document.getElementById('enemy-shadow');
            shadow.innerHTML = '';
            // Противник — это просто веер рубашек (неизвестность)
            vchf_state.eHand.forEach(() => {
                const back = document.createElement('div');
                back.className = 'enemy-card-back';
                shadow.appendChild(back);
            });
        }

        function finalizeRitual() {
            vchf_state.phase = 'battle';
            logStatus("РИТУАЛ ЗАВЕРШЕН. РОЖДЕНИЕ ТОТЕНА...");
            // Переход к Window 5 (Тотен и Мозги)
            if (typeof spawnTotem === "function") spawnTotem();
        }
        /* --- WINDOW 5: TOTEM GHOST & HUMANIZED AI MEMORY --- */

        function spawnTotem() {
            // Выбираем случайный козырь из мастей
            const randomSuit = SUITS[Math.floor(Math.random() * SUITS.length)];
            vchf_state.trump = randomSuit;
            
            const totem = document.getElementById('totem-ghost');
            totem.innerHTML = randomSuit;
            totem.className = 'pulsing-aura';
            
            // Цвет Тотена в зависимости от масти
            const isRed = (randomSuit === '♥' || randomSuit === '♦');
            totem.style.color = isRed ? 'var(--vchf-red)' : '#fff';
            
            // Обновляем визуализацию козырей в Бутоне
            markTrumpCards();
            
            logStatus(`КОЗЫРЬ: ${randomSuit}`);
            
            // Начинаем цикл смены козыря (Блуждающий Огонь)
            startChaosTimer();
        }

        function markTrumpCards() {
            // Игрок видит свои козыри
            const cards = document.querySelectorAll('.vchf-card');
            cards.forEach(cardEl => {
                const suitIcon = cardEl.querySelector('.card-suit-main').innerText;
                if (suitIcon === vchf_state.trump) {
                    cardEl.classList.add('is-trump');
                } else {
                    cardEl.classList.remove('is-trump');
                }
            });
            
            // ИИ помечает для себя козыри во внутреннем состоянии
            vchf_state.eHand.forEach(c => {
                c.isTrump = (c.suit === vchf_state.trump);
            });
        }

        /* --- ЛОГИКА ПАМЯТИ ИИ (Число Миллера 7 +/- 2) --- */
        
        function updateAiMemory(card) {
            // ИИ запоминает карту, которая ушла в Бито или на стол
            vchf_state.aiMemory.push({
                rank: card.rank,
                suit: card.suit,
                val: card.val,
                timestamp: Date.now()
            });

            // Лимит Миллера: ИИ держит в памяти только последние 7 объектов
            if (vchf_state.aiMemory.length > 7) {
                vchf_state.aiMemory.shift(); // Забывает самую старую карту
            }
        }

        function aiShouldForget() {
            // Эффект забывчивости: чем дольше идет игра, тем выше шанс ошибки
            return Math.random() < vchf_state.aiForgetRate;
        }

        function getAiDecision(attackCard = null) {
            // Имитация "раздумий" человека
            if (aiShouldForget()) {
                logStatus("ИИ В ЗАМЕШАТЕЛЬСТВЕ...");
                // ИИ может "забыть", что у него есть карта сильнее, и взять
                return null; 
            }

            // Если ИИ защищается
            if (attackCard) {
                const defenseOptions = vchf_state.eHand.filter(c => {
                    // Бьем той же мастью выше ИЛИ козырем (если атака не козырь)
                    const sameSuitHigher = (c.suit === attackCard.suit && c.val > attackCard.val);
                    const trumpCover = (vchf_state.trump === c.suit && vchf_state.trump !== attackCard.suit);
                    return sameSuitHigher || trumpCover;
                }).sort((a, b) => a.val - b.val); // Берет самую слабую из подходящих

                return defenseOptions.length > 0 ? defenseOptions[0] : null;
            }
            
            // Если ИИ атакует
            const attackOptions = [...vchf_state.eHand].sort((a, b) => a.val - b.val);
            // ИИ старается не ходить с козыря в начале
            const nonTrump = attackOptions.filter(c => c.suit !== vchf_state.trump);
            return nonTrump.length > 0 ? nonTrump[0] : attackOptions[0];
        }

        function startChaosTimer() {
            // Смена козыря каждые 45-60 секунд для Хаоса
            setInterval(() => {
                if (!vchf_state.active) return;
                vchf_state.oldTrump = vchf_state.trump;
                vchf_state.isMirrorRound = true;
                
                logStatus("ЗЕРКАЛЬНЫЙ РАУНД: МАСТЬ МЕНЯЕТСЯ!");
                spawnTotem(); // Меняем козырь
                
                // Через 7 секунд старый козырь теряет силу (наша фишка)
                setTimeout(() => {
                    vchf_state.isMirrorRound = false;
                    vchf_state.oldTrump = null;
                    logStatus("РЕАЛЬНОСТЬ ФИКСИРОВАНА");
                    markTrumpCards();
                }, 7000);
            }, 50000);
        }
        /* --- WINDOW 6: BATTLE LOGIC & PLAYER ACTIONS --- */

        function handleCardPlay(card) {
            // Проверка: твоя ли очередь и фаза боя
            if (vchf_state.phase !== 'battle') return;
            if (vchf_state.turn !== 'player' && vchf_state.table.length % 2 === 0) {
                logStatus("ЖДИ ХОДА ПРОТИВНИКА");
                return;
            }

            const canPlay = canMove(card);
            if (!canPlay) {
                logStatus("ТАК НЕЛЬЗЯ: НУЖНА ТА ЖЕ МАСТЬ ИЛИ КОЗЫРЬ");
                return;
            }

            // Перемещение карты из Бутона на поле
            vchf_state.pHand = vchf_state.pHand.filter(c => c.id !== card.id);
            executeMove(card, 'player');

            // Если это была защита, ждем хода ИИ. Если атака — ИИ защищается.
            if (vchf_state.table.length % 2 !== 0) {
                setTimeout(enemyDefense, 1000);
            } else {
                updateBitoStatus();
            }
        }

        function canMove(card) {
            // Если стол пуст — ходить можно чем угодно
            if (vchf_state.table.length === 0) return true;

            const lastCard = vchf_state.table[vchf_state.table.length - 1];
            
            // Если мы защищаемся
            if (vchf_state.table.length % 2 !== 0) {
                const isTrump = card.suit === vchf_state.trump || (vchf_state.isMirrorRound && card.suit === vchf_state.oldTrump);
                const lastIsTrump = lastCard.suit === vchf_state.trump || (vchf_state.isMirrorRound && lastCard.suit === vchf_state.oldTrump);

                if (card.suit === lastCard.suit) {
                    return card.val > lastCard.val;
                }
                return isTrump && !lastIsTrump;
            }

            // Если мы подкидываем в атаку
            return vchf_state.table.some(c => c.rank === card.rank);
        }

        function executeMove(card, owner) {
            vchf_state.table.push(card);
            updateAiMemory(card); // ИИ "видит" и запоминает карту в пределах 7 штук
            
            const field = document.getElementById('battle-field');
            const cardEl = document.createElement('div');
            cardEl.className = `vchf-card ${card.color} ${card.suit === vchf_state.trump ? 'is-trump' : ''}`;
            cardEl.style.position = 'relative';
            cardEl.style.zIndex = vchf_state.table.length;
            cardEl.style.transform = `rotate(${Math.random() * 10 - 5}deg)`;
            
            cardEl.innerHTML = `
                <div class="card-rank">${card.rank}</div>
                <div class="card-suit-main">${card.suit}</div>
                <div class="card-rank-rev">${card.rank}</div>
            `;
            
            field.appendChild(cardEl);
            
            if (owner === 'player') renderPlayerBud();
            else renderEnemyShadow();

            updateBitoStatus();
        }

        function enemyDefense() {
            const attackCard = vchf_state.table[vchf_state.table.length - 1];
            const defenseCard = getAiDecision(attackCard);

            if (defenseCard) {
                vchf_state.eHand = vchf_state.eHand.filter(c => c.id !== defenseCard.id);
                executeMove(defenseCard, 'enemy');
                logStatus("ИИ ОТБИВАЕТСЯ");
            } else {
                logStatus("ИИ БЕРЕТ КАРТЫ");
                handleTake('enemy');
            }
        }

        function enemyAttack() {
            if (vchf_state.eHand.length === 0) {
                checkEndGame();
                return;
            }
            const attackCard = getAiDecision();
            if (attackCard) {
                vchf_state.eHand = vchf_state.eHand.filter(c => c.id !== attackCard.id);
                executeMove(attackCard, 'enemy');
                logStatus("ИИ АТАКУЕТ");
            }
        }

        function updateBitoStatus() {
            const bitoBtn = document.getElementById('btn-bito');
            // Кнопка активна, если на столе четное кол-во карт (все отбито)
            bitoBtn.disabled = !(vchf_state.table.length > 0 && vchf_state.table.length % 2 === 0);
        }
        /* --- WINDOW 7: TAKE WINDOW & BITO LOGIC --- */

        function vchfTake() {
            if (vchf_state.table.length === 0 || vchf_state.phase === 'take_window') return;
            handleTake('player');
        }

        function handleTake(who) {
            vchf_state.phase = 'take_window';
            let timeLeft = 5;
            
            const mode = (who === 'player') ? "ВЫ БЕРЕТЕ" : "ИИ БЕРЕТ";
            logStatus(`ОКНО СБРОСА: ${mode} (${timeLeft}с)`);

            const takeInterval = setInterval(() => {
                timeLeft--;
                if (timeLeft <= 0) {
                    clearInterval(takeInterval);
                    finalizeTake(who);
                } else {
                    logStatus(`ОКНО СБРОСА: ${timeLeft} сек...`);
                    // Если берет игрок, ИИ пытается подкинуть карты тех же рангов
                    if (who === 'player') aiTossIn();
                }
            }, 1000);
        }

        function aiTossIn() {
            // ИИ анализирует стол и подкидывает, если есть подходящие ранги
            const tableRanks = vchf_state.table.map(c => c.rank);
            const tossCandidate = vchf_state.eHand.find(c => 
                tableRanks.includes(c.rank) && c.suit !== vchf_state.trump
            );

            if (tossCandidate && vchf_state.table.length < 12) {
                vchf_state.eHand = vchf_state.eHand.filter(c => c.id !== tossCandidate.id);
                executeMove(tossCandidate, 'enemy');
                logStatus("ИИ ПОДКИНУЛ ВДОГОНКУ!");
            }
        }

        function finalizeTake(who) {
            const tableCards = [...vchf_state.table];
            if (who === 'player') {
                vchf_state.pHand.push(...tableCards);
                vchf_state.turn = 'enemy'; // После взятия ход переходит к противнику
            } else {
                vchf_state.eHand.push(...tableCards);
                vchf_state.turn = 'player';
            }

            vchf_state.table = [];
            document.getElementById('battle-field').innerHTML = '';
            vchf_state.phase = 'battle';
            
            renderPlayerBud();
            renderEnemyShadow();
            checkEndGame();

            if (vchf_state.turn === 'enemy') {
                setTimeout(enemyAttack, 1500);
            } else {
                logStatus("ВАШ ХОД (АТАКА)");
            }
        }

        function vchfBito() {
            if (vchf_state.table.length === 0 || vchf_state.table.length % 2 !== 0) return;
            
            // Карты уходят в Бито (ИИ их запоминает временно через updateAiMemory в Window 6)
            vchf_state.table = [];
            document.getElementById('battle-field').innerHTML = '';
            
            // Смена ролей
            vchf_state.turn = vchf_state.turn === 'player' ? 'enemy' : 'player';
            vchf_state.phase = 'battle';
            
            logStatus(vchf_state.turn === 'player' ? "БИТО. ВАШ ХОД" : "БИТО. ХОД ИИ");
            
            checkEndGame();
            if (vchf_state.turn === 'enemy') {
                setTimeout(enemyAttack, 1500);
            }
        }

        // Помощник для обновления интерфейса кнопок
        function updateActionButtons() {
            const takeBtn = document.getElementById('btn-take');
            const bitoBtn = document.getElementById('btn-bito');
            
            takeBtn.disabled = (vchf_state.table.length === 0 || vchf_state.phase === 'take_window');
            updateBitoStatus(); // Из Window 6
        }
        /* --- WINDOW 8: ENDGAME LOGIC & REBIRTH --- */

        function checkEndGame() {
            // Игра заканчивается, когда колода пуста (сфер нет) и у кого-то 0 карт
            if (vchf_state.deck.length > 0) return;

            const pCount = vchf_state.pHand.length;
            const eCount = vchf_state.eHand.length;

            if (pCount === 0 && eCount === 0) {
                showEndScreen("НИЧЬЯ: ХАОС СБАЛАНСИРОВАН");
            } else if (pCount === 0) {
                showEndScreen("WANDERER ПОБЕДИЛ СИСТЕМУ!");
            } else if (eCount === 0) {
                showEndScreen("ИИ ДОМИНИРУЕТ. НУЖЕН РЕВАНШ?");
            }
        }

        function showEndScreen(msg) {
            vchf_state.active = false;
            const endOverlay = document.getElementById('end-screen');
            endOverlay.style.display = 'flex';
            
            endOverlay.innerHTML = `
                <div style="margin-bottom: 30px;">
                    <h2 style="font-size: 28px; letter-spacing: 5px; color: var(--vchf-gold);">${msg}</h2>
                    <p style="font-size: 10px; margin-top: 10px; opacity: 0.6; color: #fff;">МАНИФЕСТ МОНОЛИТА: ШАНС ЕСТЬ ВСЕГДА</p>
                </div>
                <div style="display: flex; gap: 20px;">
                    <button class="ready-trigger" style="font-size: 14px; padding: 10px 20px;" onclick="restartCycle(true)">ПРОДОЛЖИТЬ</button>
                    <button class="ready-trigger" style="font-size: 14px; padding: 10px 20px; border-color: #555; color: #555;" onclick="restartCycle(false)">ВЫЙТИ</button>
                </div>
            `;
        }

        function restartCycle(keepExperience) {
            // Если "Продолжить" - мы могли бы сохранить aiForgetRate или веса (на будущее)
            if (!keepExperience) {
                // Полная перезагрузка страницы для "Выхода"
                location.reload();
                return;
            }

            // Мягкий перезапуск игры без перезагрузки страницы
            document.getElementById('end-screen').style.display = 'none';
            document.getElementById('battle-field').innerHTML = '';
            document.getElementById('enemy-shadow').innerHTML = '';
            
            // Сброс состояния, но сохранение некоторых параметров ИИ
            vchf_state.pHand = [];
            vchf_state.eHand = [];
            vchf_state.table = [];
            vchf_state.phase = 'gathering';
            vchf_state.active = true;
            
            // Запуск заново
            createDeck();
            spawnDestinyCircle();
            logStatus("НОВЫЙ ЦИКЛ НАЧАТ");
        }

        // Вспомогательная функция анимации для кнопок
        document.querySelectorAll('.vchf-action-btn').forEach(btn => {
            btn.addEventListener('touchstart', () => {
                btn.style.transform = 'scale(0.9)';
            });
            btn.addEventListener('touchend', () => {
                btn.style.transform = 'scale(1)';
            });
        });
        /* --- WINDOW 9: RITUAL CANVAS & SYSTEM BOOT --- */

        const canvas = document.getElementById('ritual-canvas');
        const ctx = canvas.getContext('2d');
        let particles = [];

        function startRitualBG() {
            vchf_state.active = true;
            resizeCanvas();
            createParticles();
            animateRitual();
        }

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }

        function createParticles() {
            particles = [];
            const count = 40; // Оптимально для мобильных
            for (let i = 0; i < count; i++) {
                particles.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    size: Math.random() * 2 + 1,
                    speedY: Math.random() * 0.5 + 0.2,
                    opacity: Math.random() * 0.5 + 0.1
                });
            }
        }

        function animateRitual() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#d4af37'; // Золотая пыль Хаоса

            particles.forEach(p => {
                p.y -= p.speedY;
                if (p.y < 0) {
                    p.y = canvas.height;
                    p.x = Math.random() * canvas.width;
                }
                ctx.globalAlpha = p.opacity;
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                ctx.fill();
            });

            if (vchf_state.active) {
                requestAnimationFrame(animateRitual);
            }
        }

        // Обработка системных событий
        window.addEventListener('resize', () => {
            resizeCanvas();
            createParticles();
        });

        // Блокировка стандартного контекстного меню для чистоты погружения
        document.addEventListener('contextmenu', (e) => e.preventDefault());

        // ФИНАЛЬНАЯ ПРОВЕРКА МОНОЛИТА
        console.log("НУЛЕВОЙ ХАОС: МОНОЛИТ СОБРАН ПОЛНОСТЬЮ.");
        console.log("WANDERER, ТВОЙ 'ЛОТТО-2026' ОБРЕЛ ДУШУ.");
        console.log("МАНИФЕСТ МОНОЛИТА: ИНТЕГРИРОВАНО 100%.");

    </script>
    
    <div id="end-screen"></div>
</body>
</html>
