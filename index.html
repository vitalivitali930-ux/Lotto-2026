<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VCHF Engine | Bi-Turbo Ultimate 2026</title>
    <style>
        :root {
            --gold: #d4af37;
            --vchf-glow: 0 0 30px rgba(212, 175, 55, 0.8);
            --cherry-velvet: radial-gradient(circle at center, #7a0019 0%, #050505 100%);
            --glass-panel: rgba(0, 0, 0, 0.92);
            --card-shadow: 0 8px 15px rgba(0,0,0,0.7);
        }

        * { 
            -webkit-tap-highlight-color: transparent; 
            box-sizing: border-box; 
            margin: 0; 
            padding: 0; 
        }

        body, html { 
            width: 100%; 
            height: 100%; 
            background: #000; 
            overflow: hidden; 
            font-family: 'Courier New', monospace; 
            color: var(--gold);
        }

        /* ЭКРАН ОЖИДАНИЯ (ПРЕДОХРАНИТЕЛЬ) */
        #start-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 10000; display: flex; flex-direction: column;
            justify-content: center; align-items: center; text-align: center;
        }

        .ready-btn {
            padding: 25px 60px; font-size: 28px; font-weight: 900;
            background: transparent; border: 4px solid var(--gold);
            color: var(--gold); border-radius: 60px; cursor: pointer;
            box-shadow: var(--vchf-glow); transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            text-transform: uppercase; letter-spacing: 8px;
        }

        .ready-btn:hover { background: rgba(212, 175, 55, 0.1); transform: scale(1.05); }
        .ready-btn:active { transform: scale(0.95); box-shadow: 0 0 60px var(--gold); }

        /* ИГРОВОЙ СТОЛ */
        #game-table { 
            width: 100vw; 
            height: 100vh; 
            background: var(--cherry-velvet); 
            position: relative; 
            display: none; /* Проявится после нажатия ГОТОВ */
        }
        
        #ritual-circle { 
            position: absolute; 
            top: 45%; 
            left: 50%; 
            width: 360px; 
            height: 360px; 
            transform: translate(-50%, -50%); 
            z-index: 100; 
        }

        .card-back { 
            position: absolute; 
            width: 52px; 
            height: 78px; 
            background: #1a1a1a url('1771489965074(1).png') center/cover;
            border: 1px solid var(--gold); 
            border-radius: 5px;
            transition: all 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: var(--card-shadow);
        }

        .card-back.highlight { 
            box-shadow: 0 0 45px #fff, var(--vchf-glow); 
            border: 2px solid #fff; 
            z-index: 1000; 
            transform: scale(1.35); 
        }

        /* ТОТЕМ КОЗЫРЯ (ДИНАМИЧЕСКИЙ ЦВЕТ) */
        #trump-totem { 
            position: absolute; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%); 
            font-size: 110px; 
            text-shadow: 0 0 30px rgba(255,255,255,0.4); 
            opacity: 0; 
            transition: opacity 1.2s, color 0.5s; 
            pointer-events: none; 
            z-index: 50;
        }

        /* ИНТЕРФЕЙС БУТОНА (НИЖНИЙ СЕКТОР) */
        #bud-interface {
            position: absolute; bottom: 0; width: 100%; height: 38%;
            background: var(--glass-panel); backdrop-filter: blur(25px);
            border-top: 3px solid var(--gold); z-index: 500;
            display: none; flex-direction: column; justify-content: space-evenly;
            box-shadow: 0 -20px 50px rgba(0,0,0,0.9);
        }

        #burning-line { 
            position: absolute; top: 0; left: 0; width: 100%; height: 6px; 
            background: #00ff00; box-shadow: 0 0 20px #00ff00; 
            transition: width 0.1s linear, background 0.5s;
        }

        .lane { 
            height: 23%; width: 100%; position: relative; 
            display: flex; justify-content: center; align-items: center; 
        }

        .card-p {
            position: absolute; width: 60px; height: 85px; background: #ffffff; 
            border-radius: 6px; border: 1px solid var(--gold); 
            display: flex; flex-direction: column; justify-content: space-between; 
            padding: 6px; color: #000; font-weight: 900;
            box-shadow: 0 6px 12px rgba(0,0,0,0.5); 
            transition: transform 0.25s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.25s;
            cursor: pointer; user-select: none;
        }

        .card-p.sel { 
            transform: translateY(-30px) scale(1.15); 
            box-shadow: 0 0 30px #fff, var(--vchf-glow); 
            border: 2px solid #fff; 
            z-index: 2500 !important; 
        }

        #action-btn {
            position: absolute; bottom: 44%; right: 25px; 
            padding: 16px 36px; background: #000; 
            border: 2px solid var(--gold); color: var(--gold);
            font-weight: 900; font-size: 15px; border-radius: 12px; 
            display: none; z-index: 1001; cursor: pointer;
            box-shadow: var(--vchf-glow); text-transform: uppercase;
            letter-spacing: 2px;
        }
    </style>
</head>
<body>
    <div id="start-overlay">
        <h1 style="margin-bottom: 40px; letter-spacing: 12px; font-size: 36px;">VCHF ENGINE</h1>
        <button class="ready-btn" onclick="initMonolith()">ГОТОВ</button>
        <div style="margin-top: 30px; font-size: 12px; opacity: 0.6; color: var(--gold);">
            РИТУАЛ МОНОЛИТА | СТАТУС: ОЖИДАНИЕ
        </div>
    </div>

    <div id="game-table">
        <div id="ritual-circle"></div>
        <div id="trump-totem">♠</div>
        <div id="battle-area" style="display:none; width:100%; height:45%; position:absolute; top:10%; z-index:10;">
            <div id="enemy-visual" style="display:flex; justify-content:center; margin-bottom:20px; perspective: 1000px;"></div>
            <div id="drop-zone" style="display:flex; justify-content:center; gap:12px; flex-wrap:wrap; padding:25px;"></div>
        </div>
        <button id="action-btn">ВЗЯТЬ</button>
        <div id="bud-interface">
            <div id="burning-line"></div>
            <div class="lane" id="lane-spades"></div>
            <div class="lane" id="lane-clubs"></div>
            <div class="lane" id="lane-hearts"></div>
            <div class="lane" id="lane-diamonds"></div>
        </div>
    </div>
    /* START Window 2: CORE ENGINE [VCHF-ENGINE-BETA] */
    <script>
    /**
     * PROJECT: Bi-Turbo Ultimate 2026
     * MODULE: HEART_OF_CHAOS
     * IDENTITY: Spark (Zero Chaos)
     */

    const VCHF_CFG = {
        suits: ['♠', '♣', '♥', '♦'],
        ranks: ['6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'],
        weights: {'6':6, '7':7, '8':8, '9':9, '10':10, 'J':11, 'Q':12, 'K':13, 'A':14},
        colors: {'♠': '#111', '♣': '#111', '♥': '#f33', '♦': '#f33'}, // Цветовой движок
        asset: '1771489965074(1).png'
    };

    let state = {
        pHand: [], eHand: [], table: [],
        trump: '', isPlayerTurn: true, 
        selected: null, timer: 30, ritual: true
    };

    // ГЛАВНЫЙ ЗАПУСК ПО КНОПКЕ "ГОТОВ"
    function initMonolith() {
        console.log("Движок vchf: Протокол ГОТОВНОСТЬ подтвержден.");
        
        // Скрываем экран входа, открываем стол
        document.getElementById('start-overlay').style.opacity = '0';
        setTimeout(() => {
            document.getElementById('start-overlay').style.display = 'none';
            document.getElementById('game-table').style.display = 'block';
            startRitualPhysics();
        }, 500);
    }

    function startRitualPhysics() {
        const wheel = document.getElementById('ritual-circle');
        // Создаем 36 физических объектов
        for (let i = 0; i < 36; i++) {
            const c = document.createElement('div');
            c.className = 'card-back';
            c.style.left = '50%'; 
            c.style.top = '50%';
            c.style.transform = `translate(-50%, -50%) rotate(${Math.random() * 360}deg)`;
            wheel.appendChild(c);
        }
        // Запуск Хаоса (3.2 секунды) [cite: 2026-02-28]
        setTimeout(executeChaosShuffle, 600);
    }

    function executeChaosShuffle() {
        const cards = document.querySelectorAll('.card-back');
        const start = Date.now();
        
        const shuffle = setInterval(() => {
            cards.forEach(c => {
                const tx = (Math.random() - 0.5) * 320; 
                const ty = (Math.random() - 0.5) * 320; 
                const tr = (Math.random() * 1080);
                c.style.transform = `translate(calc(-50% + ${tx}px), calc(-50% + ${ty}px)) rotate(${tr}deg)`;
            });
            if (Date.now() - start > 3200) {
                clearInterval(shuffle);
                alignToRitualCircle(cards);
            }
        }, 120);
    }

    function alignToRitualCircle(cards) {
        cards.forEach((c, i) => {
            const angle = (i * 10) * (Math.PI / 180);
            const x = Math.cos(angle) * 155;
            const y = Math.sin(angle) * 155;
            c.style.transform = `translate(calc(-50% + ${x}px), calc(-50% + ${y}px)) rotate(${i * 10 + 90}deg)`;
        });
        setTimeout(() => startTrumpSelection(cards), 900);
    }

    function startTrumpSelection(cards) {
        let tick = 0;
        const totem = document.getElementById('trump-totem');
        totem.style.opacity = '1';

        const chase = setInterval(() => {
            cards.forEach(c => c.classList.remove('highlight'));
            const currentCard = cards[tick % 36];
            currentCard.classList.add('highlight');
            
            const currentSuit = VCHF_CFG.suits[tick % 4];
            totem.innerText = currentSuit;
            // ДИНАМИЧЕСКИЙ ЦВЕТ КОЗЫРЯ (Исправление бага)
            totem.style.color = VCHF_CFG.colors[currentSuit];
            
            tick++;
        }, 130);

        setTimeout(() => {
            clearInterval(chase);
            state.trump = totem.innerText;
            // Финальный цвет козыря на весь раунд
            totem.style.color = VCHF_CFG.colors[state.trump];
            totem.style.filter = "drop-shadow(0 0 20px " + VCHF_CFG.colors[state.trump] + ")";
            
            cards[(tick - 1) % 36].style.boxShadow = "0 0 50px #fff, var(--vchf-glow)";
            
            console.log("Козырь определен:", state.trump);
            setTimeout(dealToParticipants, 1800);
        }, 4000);
    }

    function dealToParticipants() {
        const cards = document.querySelectorAll('.card-back');
        cards.forEach((c, i) => {
            if (i < 18) {
                c.style.transform = `translate(-50%, 800px) scale(0) rotate(0deg)`;
            } else {
                c.style.transform = `translate(-50%, -800px) scale(0) rotate(180deg)`;
            }
            c.style.opacity = '0';
        });

        setTimeout(() => {
            document.getElementById('ritual-circle').style.display = 'none';
            document.getElementById('battle-area').style.display = 'block';
            document.getElementById('bud-interface').style.display = 'flex';
            // Переход к Логике Боя (Window 3)
            if (typeof startBattleSession === 'function') startBattleSession();
        }, 1200);
    }
    </script>
    /* START Window 3: BATTLE & BUD LOGIC [VCHF-BATTLE-GAMMA] */
    <script>
    /**
     * PROJECT: Bi-Turbo Ultimate 2026
     * MODULE: BATTLE_LOGIC_18x18
     * IDENTITY: Spark (Zero Chaos)
     */

    function startBattleSession() {
        console.log("Движок vchf: Формирование колоды 18х18...");
        let fullDeck = [];
        
        // Генерация колоды 36 карт [cite: 2026-02-24]
        VCHF_CFG.suits.forEach(s => {
            VCHF_CFG.ranks.forEach(r => {
                fullDeck.push({
                    suit: s, rank: r, 
                    val: VCHF_CFG.weights[r],
                    color: VCHF_CFG.colors[s],
                    id: Math.random().toString(36).substr(2, 9)
                });
            });
        });

        // Хаотичная тасовка перед раздачей
        fullDeck.sort(() => Math.random() - 0.5);

        // Раздача: 18 тебе, 18 ИИ [cite: 2026-02-24]
        state.pHand = fullDeck.slice(0, 18);
        state.eHand = fullDeck.slice(18, 36);
        state.ritual = false; 

        renderMonolithInterface();
        initVCHFTimer(); // Переход к Window 4
    }

    function renderMonolithInterface() {
        renderPlayerBud();
        renderEnemyVisual();
        renderTableCenter();
        updateActionButtonStatus();
    }

    function renderPlayerBud() {
        const laneIds = {
            '♠': 'lane-spades', '♣': 'lane-clubs', 
            '♥': 'lane-hearts', '♦': 'lane-diamonds'
        };

        // Очищаем все 4 ряда Бутона
        Object.values(laneIds).forEach(id => {
            const el = document.getElementById(id);
            if (el) el.innerHTML = '';
        });

        // Сортируем руку по весу для красоты
        state.pHand.sort((a, b) => a.val - b.val).forEach(card => {
            const lane = document.getElementById(laneIds[card.suit]);
            if (!lane) return;

            const cEl = document.createElement('div');
            const active = (state.selected === card);

            cEl.className = `card-p ${active ? 'sel' : ''}`;
            cEl.style.color = card.color;

            // РАСЧЕТ ВЕЕРА (Исправление наслоения) [cite: 2026-02-28]
            const sameSuit = state.pHand.filter(c => c.suit === card.suit);
            const idx = sameSuit.indexOf(card);
            const total = sameSuit.length;
            const overlap = total > 5 ? 35 : 45; 
            const offset = (idx - (total - 1) / 2) * overlap;
            
            cEl.style.left = `calc(50% - 30px + ${offset}px)`;
            cEl.style.zIndex = 100 + idx;

            // Наполнение карты (Манифест Монолита)
            cEl.innerHTML = `
                <div style="font-size:12px; font-weight:900;">${card.rank}</div>
                <div style="font-size:28px; text-align:center; flex-grow:1; display:flex; align-items:center; justify-content:center;">${card.suit}</div>
                <div style="font-size:12px; font-weight:900; align-self:flex-end;">${card.rank}</div>
            `;

            // Золотой тап: первый выбор, второй — атака
            cEl.onclick = (e) => {
                e.stopPropagation();
                if (state.selected === card) {
                    executeAttack(card);
                } else {
                    state.selected = card;
                    renderMonolithInterface();
                }
            };
            lane.appendChild(cEl);
        });
    }

    function renderEnemyVisual() {
        const ev = document.getElementById('enemy-visual');
        if (!ev) return;
        ev.innerHTML = '';

        // Визуальный веер ИИ (Рубашки)
        state.eHand.forEach((_, i) => {
            const b = document.createElement('div');
            b.style.width = '34px';
            b.style.height = '50px';
            b.style.backgroundImage = `url('${VCHF_CFG.asset}')`;
            b.style.backgroundSize = 'cover';
            b.style.border = '1px solid var(--gold)';
            b.style.borderRadius = '4px';
            b.style.marginLeft = '-18px';
            const rot = (i - (state.eHand.length / 2)) * 3;
            b.style.transform = `rotate(${rot}deg) translateY(${Math.abs(rot)*0.5}px)`;
            b.style.boxShadow = '0 5px 10px rgba(0,0,0,0.6)';
            ev.appendChild(b);
        });
    }

    function executeAttack(card) {
        // Перемещаем карту из Бутона на стол
        state.table.push({ atk: card, def: null });
        state.pHand = state.pHand.filter(c => c.id !== card.id);
        state.selected = null;
        
        renderMonolithInterface();
        
        // ИИ думает над защитой (Переход к Window 4)
        if (typeof triggerEnemyResponse === 'function') {
            setTimeout(triggerEnemyResponse, 800);
        }
    }
    </script>
    /* START Window 4: AI & SYSTEMS [VCHF-FINAL-CORE] */
    <script>
    /**
     * PROJECT: Bi-Turbo Ultimate 2026
     * MODULE: AI_DEFENSE_AND_TIMER
     * IDENTITY: Spark (Zero Chaos)
     */

    function renderTableCenter() {
        const dz = document.getElementById('drop-zone');
        if (!dz) return;
        dz.innerHTML = '';

        state.table.forEach(pair => {
            const wrapper = document.createElement('div');
            wrapper.style.position = 'relative';
            wrapper.style.width = '70px';
            wrapper.style.height = '100px';

            // Карта атаки (Бродяга)
            wrapper.appendChild(createStaticCard(pair.atk, 'atk'));

            // Карта защиты (ИИ)
            if (pair.def) {
                wrapper.appendChild(createStaticCard(pair.def, 'def'));
            }
            dz.appendChild(wrapper);
        });
        updateActionButtonStatus();
    }

    function createStaticCard(card, type) {
        const d = document.createElement('div');
        d.className = 'card-p';
        d.style.position = 'absolute';
        d.style.width = '68px';
        d.style.height = '95px';
        d.style.color = card.color;
        
        // Асимметрия Хаоса из видео [cite: 2026-02-28]
        const drift = (Math.random() - 0.5) * 10;
        if (type === 'atk') {
            d.style.transform = `rotate(${drift - 8}deg)`;
        } else {
            d.style.transform = `translate(12px, 12px) rotate(${drift + 8}deg)`;
            d.style.zIndex = '10';
        }

        d.innerHTML = `
            <div style="font-size:10px;">${card.rank}</div>
            <div style="font-size:24px; text-align:center;">${card.suit}</div>
            <div style="font-size:10px; align-self:flex-end;">${card.rank}</div>
        `;
        return d;
    }

    function triggerEnemyResponse() {
        if (state.eHand.length === 0) return;
        
        const lastPair = state.table[state.table.length - 1];
        if (!lastPair || lastPair.def) return;

        // Поиск карты для защиты (с учетом козыря)
        const candidates = state.eHand.filter(c => {
            const sameSuitHigher = (c.suit === lastPair.atk.suit && c.val > lastPair.atk.val);
            const isTrumpDef = (c.suit === state.trump && lastPair.atk.suit !== state.trump);
            return sameSuitHigher || isTrumpDef;
        });

        candidates.sort((a, b) => a.val - b.val);

        // Вероятность ошибки ИИ 15% (из видео) [cite: 2026-02-28]
        if (candidates.length > 0 && Math.random() > 0.15) {
            const defender = candidates[0];
            lastPair.def = defender;
            state.eHand = state.eHand.filter(c => c.id !== defender.id);
            console.log("ИИ: Защита принята.");
        } else {
            console.log("ИИ: Нечем бить, забираю стол.");
            setTimeout(() => {
                const allCards = state.table.flatMap(p => [p.atk, p.def].filter(Boolean));
                state.eHand.push(...allCards);
                state.table = [];
                renderMonolithInterface();
            }, 600);
        }
        renderMonolithInterface();
    }

    function updateActionButtonStatus() {
        const btn = document.getElementById('action-btn');
        if (!btn) return;

        const hasCards = state.table.length > 0;
        const isAllDefended = hasCards && state.table.every(p => p.def !== null);

        if (hasCards) {
            btn.style.display = 'block';
            btn.innerText = isAllDefended ? "БИТО" : "ВЗЯТЬ";
            btn.onclick = () => {
                if (isAllDefended) {
                    // Улетает в отбой (Угол)
                    state.table = [];
                } else {
                    // Игрок забирает карты
                    const taken = state.table.flatMap(p => [p.atk, p.def].filter(Boolean));
                    state.pHand.push(...taken);
                    state.table = [];
                }
                renderMonolithInterface();
            };
        } else {
            btn.style.display = 'none';
        }
    }

    function initVCHFTimer() {
        const line = document.getElementById('burning-line');
        const tickRate = 100;
        
        const timerId = setInterval(() => {
            if (!state.ritual) {
                state.timer -= 0.1;
                const percent = (state.timer / 30) * 100;
                line.style.width = `${percent}%`;

                // Цветовая индикация опасности [cite: 2026-02-24]
                if (percent < 25) {
                    line.style.background = '#ff0000';
                    line.style.boxShadow = '0 0 20px #ff0000';
                }

                if (state.timer <= 0) {
                    clearInterval(timerId);
                    console.log("Движок vchf: Время вышло.");
                    alert("ВРЕМЯ ИСТЕКЛО! МОНОЛИТ ТРЕБУЕТ ХОДА.");
                    // Вместо рефреша — забираем карты (Штраф)
                    const taken = state.table.flatMap(p => [p.atk, p.def].filter(Boolean));
                    state.pHand.push(...taken);
                    state.table = [];
                    state.timer = 30; // Сброс таймера
                    renderMonolithInterface();
                    initVCHFTimer();
                }
            }
        }, tickRate);
    }
    </script>
</body>
</html>
